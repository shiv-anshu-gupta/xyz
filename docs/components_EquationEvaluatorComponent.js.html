

<!DOCTYPE html>
<html lang="en">

<head>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title> components/EquationEvaluatorComponent.js</title>

  <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- build/entry.js removed - not needed -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,400,700|Inconsolata,700" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
  <link type="text/css" rel="stylesheet" href="https://jmblog.github.io/color-themes-for-google-code-prettify/themes/tomorrow-night.min.css">
  <link type="text/css" rel="stylesheet" href="styles/app.min.css">
  <link type="text/css" rel="stylesheet" href="styles/iframe.css">
  <link type="text/css" rel="stylesheet" href="">
  <script async defer src="https://buttons.github.io/buttons.js"></script>

  
</head>



<body class="layout small-header">
    <div id="stickyNavbarOverlay"></div>
    

<div class="top-nav">
    <div class="inner">
        <a id="hamburger" role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
        </a>
        <div class="logo">
            
            
        </div>
        <div class="menu">
            
            <div class="navigation">
                <a
                    href="index.html"
                    class="link"
                >
                    Documentation
                </a>
                
                
                
            </div>
        </div>
    </div>
</div>
    <div id="main">
        <div
            class="sidebar "
            id="sidebarNav"
        >
            
            <nav>
                
                    <h2><a href="index.html">Documentation</a></h2><div class="category"><h3>Modules</h3><ul><li><a href="module-analyzeGroupsAndPublish.html">analyzeGroupsAndPublish</a></li><li><a href="module-axisBuilder.html">axisBuilder</a></li><li><a href="module-axisCalculator.html">axisCalculator</a></li><li><a href="module-calculateAndPublishMaxYAxes.html">calculateAndPublishMaxYAxes</a></li><li><a href="module-chartAxisAlignment.html">chartAxisAlignment</a></li><li><a href="module-chartComponent.html">chartComponent</a></li><li><a href="module-chartManager.html">chartManager</a></li><li><a href="module-chartUpdateHelpers.html">chartUpdateHelpers</a></li><li><a href="module-components_renderComtradeCharts.html">components/renderComtradeCharts</a></li><li><a href="module-components_renderSingleAnalogChart.html">components/renderSingleAnalogChart</a></li><li><a href="module-components_renderSingleDigitalChart.html">components/renderSingleDigitalChart</a></li><li><a href="module-comtradeUtils.html">comtradeUtils</a></li><li><a href="module-createDragBar.html">createDragBar</a></li><li><a href="module-createState.html">createState</a></li><li><a href="module-debugMode.html">debugMode</a></li><li><a href="module-domUpdateQueue.html">domUpdateQueue</a></li><li><a href="module-domUpdateQueueInit.html">domUpdateQueueInit</a></li><li><a href="module-eventListenerManager.html">eventListenerManager</a></li><li><a href="module-handleVerticalLineShortcuts.html">handleVerticalLineShortcuts</a></li><li><a href="module-initVerticalLineControl.html">initVerticalLineControl</a></li><li><a href="module-main.html">main</a></li><li><a href="module-maxYAxesStore.html">maxYAxesStore</a></li><li><a href="module-mergerWindowLauncher.html">mergerWindowLauncher</a></li><li><a href="module-performanceMonitor.html">performanceMonitor</a></li><li><a href="module-seriesMapper.html">seriesMapper</a></li><li><a href="module-setupChartDragAndDrop.html">setupChartDragAndDrop</a></li><li><a href="module-timeInterpolation.html">timeInterpolation</a></li><li><a href="module-utils_autoGroupChannels.html">utils/autoGroupChannels</a></li><li><a href="module-verticalLineControl.html">verticalLineControl</a></li></ul><h3>Classes</h3><ul><li><a href="ComputedChannelMetadata.html">ComputedChannelMetadata</a></li><li><a href="PolarChart.html">PolarChart</a></li><li><a href="PolarChartCanvas.html">PolarChartCanvas</a></li><li><a href="SidebarStore.html">SidebarStore</a></li><li><a href="module-performanceMonitor-PhaseTracker.html">PhaseTracker</a></li></ul><h3>Global</h3><ul><li><a href="global.html#IMPLEMENTATION_COMPLETE">IMPLEMENTATION_COMPLETE</a></li><li><a href="global.html#QUICK_REFERENCE">QUICK_REFERENCE</a></li><li><a href="global.html#STORAGE_CFG_KEY">STORAGE_CFG_KEY</a></li><li><a href="global.html#adjustMainContent">adjustMainContent</a></li><li><a href="global.html#appendComputedChannelToStorage">appendComputedChannelToStorage</a></li><li><a href="global.html#attachChartContainer">attachChartContainer</a></li><li><a href="global.html#attachChartEventHandlers">attachChartEventHandlers</a></li><li><a href="global.html#attachChartPlugins">attachChartPlugins</a></li><li><a href="global.html#attachComputedChartContainer">attachComputedChartContainer</a></li><li><a href="global.html#attachComputedChartEventHandlers">attachComputedChartEventHandlers</a></li><li><a href="global.html#attachComputedChartPlugins">attachComputedChartPlugins</a></li><li><a href="global.html#axisLinesPlugin">axisLinesPlugin</a></li><li><a href="global.html#broadcastComputedChannelChange">broadcastComputedChannelChange</a></li><li><a href="global.html#buildChannelData">buildChannelData</a></li><li><a href="global.html#buildChartData">buildChartData</a></li><li><a href="global.html#buildChartOptions">buildChartOptions</a></li><li><a href="global.html#buildComputedChannelLabels">buildComputedChannelLabels</a></li><li><a href="global.html#buildComputedChannelsFromCfgAndData">buildComputedChannelsFromCfgAndData</a></li><li><a href="global.html#buildComputedChartOptions">buildComputedChartOptions</a></li><li><a href="global.html#buildGroupsWithAutoGrouping">buildGroupsWithAutoGrouping</a></li><li><a href="global.html#buildGroupsWithUserAssignments">buildGroupsWithUserAssignments</a></li><li><a href="global.html#buildTableBody">buildTableBody</a></li><li><a href="global.html#buildTableHTML">buildTableHTML</a></li><li><a href="global.html#buildTableHeader">buildTableHeader</a></li><li><a href="global.html#buildUnitChartData">buildUnitChartData</a></li><li><a href="global.html#buildWorkerErrorHandler">buildWorkerErrorHandler</a></li><li><a href="global.html#buildWorkerMessageHandler">buildWorkerMessageHandler</a></li><li><a href="global.html#buildWorkerTask">buildWorkerTask</a></li><li><a href="global.html#calculateStatistics">calculateStatistics</a></li><li><a href="global.html#calculateStats">calculateStats</a></li><li><a href="global.html#chart2">chart2</a></li><li><a href="global.html#cleanupOldComputedCharts">cleanupOldComputedCharts</a></li><li><a href="global.html#clearChartsContainer">clearChartsContainer</a></li><li><a href="global.html#clearComputedChannelsFromStorage">clearComputedChannelsFromStorage</a></li><li><a href="global.html#clearExpressionCache">clearExpressionCache</a></li><li><a href="global.html#closeAnalysisDrawer">closeAnalysisDrawer</a></li><li><a href="global.html#collectChartDeltas">collectChartDeltas</a></li><li><a href="global.html#computeChartDataDimensions">computeChartDataDimensions</a></li><li><a href="global.html#convertLatexToMathJs">convertLatexToMathJs</a></li><li><a href="global.html#convertLatexToPlainText">convertLatexToPlainText</a></li><li><a href="global.html#convertResultsToArray">convertResultsToArray</a></li><li><a href="global.html#convertToTransferableBuffers">convertToTransferableBuffers</a></li><li><a href="global.html#createAnalogChannelGroupMap">createAnalogChannelGroupMap</a></li><li><a href="global.html#createBinaryBlob">createBinaryBlob</a></li><li><a href="global.html#createChannelItem">createChannelItem</a></li><li><a href="global.html#createChannelList">createChannelList</a></li><li><a href="global.html#createChartContainer">createChartContainer</a></li><li><a href="global.html#createChartMetadata">createChartMetadata</a></li><li><a href="global.html#createChartOptions">createChartOptions</a></li><li><a href="global.html#createComputedChannelWorker">createComputedChannelWorker</a></li><li><a href="global.html#createComputedChannelsLabels">createComputedChannelsLabels</a></li><li><a href="global.html#createComputedChannelsSidebar">createComputedChannelsSidebar</a></li><li><a href="global.html#createComputedChartMetadata">createComputedChartMetadata</a></li><li><a href="global.html#createComputedClickHandler">createComputedClickHandler</a></li><li><a href="global.html#createComputedMousemoveHandler">createComputedMousemoveHandler</a></li><li><a href="global.html#createDeltaTableRenderer">createDeltaTableRenderer</a></li><li><a href="global.html#createDigitalFillPlugin">createDigitalFillPlugin</a></li><li><a href="global.html#createGroupDragBar">createGroupDragBar</a></li><li><a href="global.html#createMergedGroupChart">createMergedGroupChart</a></li><li><a href="global.html#createMousemoveHandler">createMousemoveHandler</a></li><li><a href="global.html#createProgressBar">createProgressBar</a></li><li><a href="global.html#createScopeTemplate">createScopeTemplate</a></li><li><a href="global.html#createSidebarResizer">createSidebarResizer</a></li><li><a href="global.html#createSimpleChannelList">createSimpleChannelList</a></li><li><a href="global.html#createSimpleContainer">createSimpleContainer</a></li><li><a href="global.html#createState">createState</a></li><li><a href="global.html#createTooltip">createTooltip</a></li><li><a href="global.html#createVerticalLineClickHandler">createVerticalLineClickHandler</a></li><li><a href="global.html#debounce">debounce</a></li><li><a href="global.html#detectGroupFromExpression">detectGroupFromExpression</a></li><li><a href="global.html#dispatchChannelSavedEvent">dispatchChannelSavedEvent</a></li><li><a href="global.html#encodeFloat64">encodeFloat64</a></li><li><a href="global.html#encodeInt32">encodeInt32</a></li><li><a href="global.html#evaluateAndSaveComputedChannel">evaluateAndSaveComputedChannel</a></li><li><a href="global.html#evaluateExpression">evaluateExpression</a></li><li><a href="global.html#exportAllChannelsAsCSV">exportAllChannelsAsCSV</a></li><li><a href="global.html#exportAllComputedChannels">exportAllComputedChannels</a></li><li><a href="global.html#exportAsASCII">exportAsASCII</a></li><li><a href="global.html#exportComputedChannelAsASCII">exportComputedChannelAsASCII</a></li><li><a href="global.html#exportComputedChannelAsCFGDAT">exportComputedChannelAsCFGDAT</a></li><li><a href="global.html#exportComputedChannelsAsCSV">exportComputedChannelsAsCSV</a></li><li><a href="global.html#extractChannelMetadata">extractChannelMetadata</a></li><li><a href="global.html#extractChannelNameFromEquation">extractChannelNameFromEquation</a></li><li><a href="global.html#extractDataSources">extractDataSources</a></li><li><a href="global.html#extractGroupId">extractGroupId</a></li><li><a href="global.html#extractMathExpression">extractMathExpression</a></li><li><a href="global.html#extractUsedChannelNames">extractUsedChannelNames</a></li><li><a href="global.html#filterGroupsWithChannels">filterGroupsWithChannels</a></li><li><a href="global.html#filterIndicesWithData">filterIndicesWithData</a></li><li><a href="global.html#filterTableRows">filterTableRows</a></li><li><a href="global.html#filterUnassignedComputedChannels">filterUnassignedComputedChannels</a></li><li><a href="global.html#filterValidIndices">filterValidIndices</a></li><li><a href="global.html#formatEquationForLatex">formatEquationForLatex</a></li><li><a href="global.html#formatScaledValue">formatScaledValue</a></li><li><a href="global.html#formatTableData">formatTableData</a></li><li><a href="global.html#generateCFGContent">generateCFGContent</a></li><li><a href="global.html#generateCFGContentBatch">generateCFGContentBatch</a></li><li><a href="global.html#generateCFGContentBinary32">generateCFGContentBinary32</a></li><li><a href="global.html#generateCFGContentBinary64">generateCFGContentBinary64</a></li><li><a href="global.html#generateCFGContentFloat32">generateCFGContentFloat32</a></li><li><a href="global.html#generateCFGContentFloat64">generateCFGContentFloat64</a></li><li><a href="global.html#generateChannelName">generateChannelName</a></li><li><a href="global.html#generateDATContent">generateDATContent</a></li><li><a href="global.html#generateDATContentBatch">generateDATContentBatch</a></li><li><a href="global.html#generateDATContentBinary32">generateDATContentBinary32</a></li><li><a href="global.html#generateDATContentBinary64">generateDATContentBinary64</a></li><li><a href="global.html#generateDATContentFloat32">generateDATContentFloat32</a></li><li><a href="global.html#generateDATContentFloat64">generateDATContentFloat64</a></li><li><a href="global.html#generateUniqueComputedGroup">generateUniqueComputedGroup</a></li><li><a href="global.html#getAllAvailableGroups">getAllAvailableGroups</a></li><li><a href="global.html#getCacheStats">getCacheStats</a></li><li><a href="global.html#getChannelByDisplayName">getChannelByDisplayName</a></li><li><a href="global.html#getChannelMetadata">getChannelMetadata</a></li><li><a href="global.html#getChannelsForFile">getChannelsForFile</a></li><li><a href="global.html#getColorHex">getColorHex</a></li><li><a href="global.html#getCompiledExpression">getCompiledExpression</a></li><li><a href="global.html#getComputedChannelById">getComputedChannelById</a></li><li><a href="global.html#getComputedChannelStorageMetadata">getComputedChannelStorageMetadata</a></li><li><a href="global.html#getComputedChannelsState">getComputedChannelsState</a></li><li><a href="global.html#getElementWidth">getElementWidth</a></li><li><a href="global.html#getFileIndexForTime">getFileIndexForTime</a></li><li><a href="global.html#getOriginalChannelName">getOriginalChannelName</a></li><li><a href="global.html#getSampleIndexInFile">getSampleIndexInFile</a></li><li><a href="global.html#groupCfgDatFiles">groupCfgDatFiles</a></li><li><a href="global.html#groupChannelsByUnit">groupChannelsByUnit</a></li><li><a href="global.html#handleComputedChannelEvaluation">handleComputedChannelEvaluation</a></li><li><a href="global.html#handleComputedVerticalLineAddition">handleComputedVerticalLineAddition</a></li><li><a href="global.html#handleVerticalLineAddition">handleVerticalLineAddition</a></li><li><a href="global.html#hasDigitalData">hasDigitalData</a></li><li><a href="global.html#hasStoredComputedChannels">hasStoredComputedChannels</a></li><li><a href="global.html#hideProgress">hideProgress</a></li><li><a href="global.html#hideTooltip">hideTooltip</a></li><li><a href="global.html#importComputedChannelFromJSON">importComputedChannelFromJSON</a></li><li><a href="global.html#initComputedChannelsState">initComputedChannelsState</a></li><li><a href="global.html#initUPlotChart">initUPlotChart</a></li><li><a href="global.html#initializeChartInstance">initializeChartInstance</a></li><li><a href="global.html#initializeComputedChartInstance">initializeComputedChartInstance</a></li><li><a href="global.html#initializeSidebarChannels">initializeSidebarChannels</a></li><li><a href="global.html#injectSidebarIntoUplot">injectSidebarIntoUplot</a></li><li><a href="global.html#isMathJaxLoaded">isMathJaxLoaded</a></li><li><a href="global.html#listenForComputedChannelChanges">listenForComputedChannelChanges</a></li><li><a href="global.html#loadComputedChannelsForGroup">loadComputedChannelsForGroup</a></li><li><a href="global.html#loadComputedChannelsFromStorage">loadComputedChannelsFromStorage</a></li><li><a href="global.html#loadMathJax">loadMathJax</a></li><li><a href="global.html#mathJaxPromise">mathJaxPromise</a></li><li><a href="global.html#measurePerformance">measurePerformance</a></li><li><a href="global.html#mergeAnalogAndComputedMetadata">mergeAnalogAndComputedMetadata</a></li><li><a href="global.html#mergeAnalogChannels">mergeAnalogChannels</a></li><li><a href="global.html#mergeComtradeFilesSetsSequential">mergeComtradeFilesSetsSequential</a></li><li><a href="global.html#mergeDigitalChannels">mergeDigitalChannels</a></li><li><a href="global.html#mergeTimeArraysSequential">mergeTimeArraysSequential</a></li><li><a href="global.html#notifyChildWindowError">notifyChildWindowError</a></li><li><a href="global.html#notifyChildWindowStateUpdated">notifyChildWindowStateUpdated</a></li><li><a href="global.html#notifyChildWindowSuccess">notifyChildWindowSuccess</a></li><li><a href="global.html#openAnalysisDrawer">openAnalysisDrawer</a></li><li><a href="global.html#openBothSidebars">openBothSidebars</a></li><li><a href="global.html#openDeltaWindow">openDeltaWindow</a></li><li><a href="global.html#openMathLiveEditor">openMathLiveEditor</a></li><li><a href="global.html#openPhasorDiagram">openPhasorDiagram</a></li><li><a href="global.html#performExport">performExport</a></li><li><a href="global.html#prepareChartDataContext">prepareChartDataContext</a></li><li><a href="global.html#processComputedUnitGroup">processComputedUnitGroup</a></li><li><a href="global.html#processEquationInput">processEquationInput</a></li><li><a href="global.html#readFileAsText">readFileAsText</a></li><li><a href="global.html#renameChannelWithPrefix">renameChannelWithPrefix</a></li><li><a href="global.html#renderChannelLabelContainer">renderChannelLabelContainer</a></li><li><a href="global.html#renderComputedChannels">renderComputedChannels</a></li><li><a href="global.html#renderGroupCharts">renderGroupCharts</a></li><li><a href="global.html#renderLatex">renderLatex</a></li><li><a href="global.html#resizeChartsToContainers">resizeChartsToContainers</a></li><li><a href="global.html#resolveGroupIndices">resolveGroupIndices</a></li><li><a href="global.html#resolveTimeArray">resolveTimeArray</a></li><li><a href="global.html#saveComputedChannelsToStorage">saveComputedChannelsToStorage</a></li><li><a href="global.html#saveToCfg">saveToCfg</a></li><li><a href="global.html#saveToGlobalData">saveToGlobalData</a></li><li><a href="global.html#sendTaskToWorker">sendTaskToWorker</a></li><li><a href="global.html#separateComputedFiles">separateComputedFiles</a></li><li><a href="global.html#serializeChannelMetadata">serializeChannelMetadata</a></li><li><a href="global.html#setupMobileSidebar">setupMobileSidebar</a></li><li><a href="global.html#showChannelListWindow">showChannelListWindow</a></li><li><a href="global.html#showError">showError</a></li><li><a href="global.html#showExportFormatDialog">showExportFormatDialog</a></li><li><a href="global.html#showFileInfo">showFileInfo</a></li><li><a href="global.html#showProgress">showProgress</a></li><li><a href="global.html#sortFilePairs">sortFilePairs</a></li><li><a href="global.html#subscribeChartUpdates">subscribeChartUpdates</a></li><li><a href="global.html#syncComputedChannelsWithParent">syncComputedChannelsWithParent</a></li><li><a href="global.html#themeContext">themeContext</a></li><li><a href="global.html#toggleChartsVisibility">toggleChartsVisibility</a></li><li><a href="global.html#updateComputedChannelGroupInStorage">updateComputedChannelGroupInStorage</a></li><li><a href="global.html#updateComputedChannelsSidebar">updateComputedChannelsSidebar</a></li><li><a href="global.html#updateFileInfo">updateFileInfo</a></li><li><a href="global.html#updateProgress">updateProgress</a></li><li><a href="global.html#updateStateStore">updateStateStore</a></li><li><a href="global.html#updateStatsCards">updateStatsCards</a></li><li><a href="global.html#updateTooltip">updateTooltip</a></li><li><a href="global.html#validateChannelName">validateChannelName</a></li><li><a href="global.html#validateExpressionPayload">validateExpressionPayload</a></li><li><a href="global.html#validateExpressionSyntax">validateExpressionSyntax</a></li><li><a href="global.html#validateGlobalData">validateGlobalData</a></li><li><a href="global.html#validateGroupIndices">validateGroupIndices</a></li><li><a href="global.html#validateSampleData">validateSampleData</a></li><li><a href="global.html#validateSampleRates">validateSampleRates</a></li><li><a href="global.html#wrapChartInSection">wrapChartInSection</a></li></ul></div>
                
            </nav>
        </div>
        <div class="core" id="main-content-wrapper">
            <div class="content">
                <header class="page-title">
                    <p>Source</p>
                    <h1>components/EquationEvaluatorComponent.js</h1>
                </header>
                



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * EquationEvaluatorComponent.js
 * Simple equation evaluator for computed channels
 */

import { createState } from "./createState.js";

export const computedChannelsState = createState([]);

let globalCfg = null;
let globalData = null;
let computedChannelsCounter = 0;

export function createEquationEvaluatorComponent(cfg, data, channelState) {
  globalCfg = cfg;
  globalData = data;

  // Initialize storage structures if not present
  if (!globalData.computedData) {
    globalData.computedData = [];
  }
  if (!globalCfg.computedChannels) {
    globalCfg.computedChannels = [];
  }

  console.log("[EquationEvaluator] Component initialized with:");
  console.log("  cfg:", cfg);
  console.log("  data:", data);
  console.log("  data.analogData length:", data?.analogData?.[0]?.length);
  console.log("  cfg.analogChannels:", cfg?.analogChannels?.length);

  const section = document.createElement("section");
  section.id = "equation-evaluator-section";
  section.classList.add("equation-evaluator-component");

  section.innerHTML = `
    &lt;h2>Equation Evaluator&lt;/h2>
    
    &lt;div class="equation-evaluator-controls">
      &lt;div class="equation-evaluator-input-wrapper">
        &lt;label for="equation-input">Equation:&lt;/label>
        &lt;input
          type="text"
          id="equation-input"
          class="equation-evaluator-input"
          placeholder="e.g., sqrt(a0^2 + a1^2)"
        >
      &lt;/div>
      &lt;button id="execute-btn" class="equation-evaluator-button">
        ‚ñ∂Ô∏è Execute
      &lt;/button>
      &lt;button id="show-channels-btn" class="equation-evaluator-button secondary">
        üìã Channels
      &lt;/button>
    &lt;/div>

    &lt;div id="results" class="equation-evaluator-results">&lt;/div>
  `;

  const equationInput = section.querySelector("#equation-input");
  const executeBtn = section.querySelector("#execute-btn");
  const showChannelsBtn = section.querySelector("#show-channels-btn");
  const resultsDiv = section.querySelector("#results");

  executeBtn.onclick = () => {
    const equation = equationInput.value.trim();
    if (!equation) {
      resultsDiv.innerHTML =
        '&lt;div class="equation-evaluator-error">Please enter an equation&lt;/div>';
      return;
    }
    executeEquation(equation, resultsDiv);
  };

  showChannelsBtn.onclick = showAllChannelsDialog;

  // Allow Enter key to execute
  equationInput.onkeypress = (e) => {
    if (e.key === "Enter") executeBtn.click();
  };

  resultsDiv.innerHTML =
    '&lt;div class="equation-evaluator-empty">Enter an equation and click Execute&lt;/div>';

  return section;
}

function executeEquation(equation, resultsDiv) {
  try {
    const compiled = math.compile(equation);
    const sampleCount =
      globalData?.analogData?.[0]?.length ||
      globalData?.analog?.[0]?.length ||
      0;
    const results = [];

    for (let i = 0; i &lt; sampleCount; i++) {
      const scope = {};

      // Use analogData or fallback to analog
      const analogArray = globalData?.analogData || globalData?.analog || [];
      analogArray.forEach((ch, idx) => {
        scope[`a${idx}`] = ch?.[i] ?? 0;
      });

      // Use digitalData or fallback to digital
      const digitalArray = globalData?.digitalData || globalData?.digital || [];
      digitalArray.forEach((ch, idx) => {
        scope[`d${idx}`] = ch?.[i] ?? 0;
      });

      // Also add by channel ID if available
      globalCfg?.analogChannels?.forEach((chCfg, idx) => {
        if (chCfg.id) {
          scope[chCfg.id] = analogArray?.[idx]?.[i] ?? 0;
        }
      });
      globalCfg?.digitalChannels?.forEach((chCfg, idx) => {
        if (chCfg.id) {
          scope[chCfg.id] = digitalArray?.[idx]?.[i] ?? 0;
        }
      });

      try {
        const value = compiled.evaluate(scope);
        results.push(Number(value) || 0);
      } catch (e) {
        results.push(NaN);
      }
    }

    const validResults = results.filter((v) => !isNaN(v));
    const stats = {
      count: results.length,
      validCount: validResults.length,
      min: Math.min(...validResults),
      max: Math.max(...validResults),
      avg: validResults.reduce((a, b) => a + b, 0) / validResults.length,
    };

    // Auto-detect scaling factor from raw data
    const firstChannelData = globalData?.analogData?.[0] || [];
    const maxRaw = Math.max(...firstChannelData.map((v) => Math.abs(v)));
    const scalingFactor = maxRaw / 2; // Assuming chart range is -2 to +2

    const scaledStats = {
      min: stats.min / scalingFactor,
      max: stats.max / scalingFactor,
      avg: stats.avg / scalingFactor,
    };

    // Store current computation for potential saving
    const currentComputation = {
      equation,
      results,
      stats,
      scaledStats,
      scalingFactor,
    };

    let html = `
      &lt;div class="equation-evaluator-summary">
        &lt;p class="equation-evaluator-summary-text">
          &lt;strong>Equation:&lt;/strong>
          &lt;code>${equation}&lt;/code>
        &lt;/p>

        &lt;div class="equation-evaluator-stats-group variant-info">
          &lt;p class="equation-evaluator-stats-title">&lt;strong>üìä Raw Values (COMTRADE)&lt;/strong>&lt;/p>
          &lt;div class="equation-evaluator-stats-grid">
            &lt;div class="equation-evaluator-stat-card">
              &lt;div class="equation-evaluator-stat-label">Samples&lt;/div>
              &lt;div class="equation-evaluator-stat-value accent-cyan">${
                stats.count
              }&lt;/div>
            &lt;/div>
            &lt;div class="equation-evaluator-stat-card">
              &lt;div class="equation-evaluator-stat-label">Valid&lt;/div>
              &lt;div class="equation-evaluator-stat-value accent-green">${
                stats.validCount
              }&lt;/div>
            &lt;/div>
            &lt;div class="equation-evaluator-stat-card">
              &lt;div class="equation-evaluator-stat-label">Min&lt;/div>
              &lt;div class="equation-evaluator-stat-value accent-blue">${stats.min.toFixed(
                0
              )}&lt;/div>
            &lt;/div>
            &lt;div class="equation-evaluator-stat-card">
              &lt;div class="equation-evaluator-stat-label">Max&lt;/div>
              &lt;div class="equation-evaluator-stat-value accent-orange">${stats.max.toFixed(
                0
              )}&lt;/div>
            &lt;/div>
            &lt;div class="equation-evaluator-stat-card">
              &lt;div class="equation-evaluator-stat-label">Average&lt;/div>
              &lt;div class="equation-evaluator-stat-value accent-purple">${stats.avg.toFixed(
                0
              )}&lt;/div>
            &lt;/div>
          &lt;/div>
        &lt;/div>

        &lt;div class="equation-evaluator-stats-group variant-success">
          &lt;p class="equation-evaluator-stats-title">&lt;strong>üìà Scaled Values (Chart Range)&lt;/strong>&lt;/p>
          &lt;div class="equation-evaluator-stats-grid">
            &lt;div class="equation-evaluator-stat-card">
              &lt;div class="equation-evaluator-stat-label">Min&lt;/div>
              &lt;div class="equation-evaluator-stat-value accent-blue">${scaledStats.min.toFixed(
                3
              )}&lt;/div>
            &lt;/div>
            &lt;div class="equation-evaluator-stat-card">
              &lt;div class="equation-evaluator-stat-label">Max&lt;/div>
              &lt;div class="equation-evaluator-stat-value accent-orange">${scaledStats.max.toFixed(
                3
              )}&lt;/div>
            &lt;/div>
            &lt;div class="equation-evaluator-stat-card">
              &lt;div class="equation-evaluator-stat-label">Average&lt;/div>
              &lt;div class="equation-evaluator-stat-value accent-green">${scaledStats.avg.toFixed(
                3
              )}&lt;/div>
            &lt;/div>
            &lt;div class="equation-evaluator-stat-card">
              &lt;div class="equation-evaluator-stat-label">Scale Factor&lt;/div>
              &lt;div class="equation-evaluator-stat-value accent-purple">${(
                scalingFactor / 1000000
              ).toFixed(2)}M&lt;/div>
            &lt;/div>
          &lt;/div>
        &lt;/div>

        &lt;div class="equation-evaluator-actions">
          &lt;button id="save-channel-btn" class="equation-evaluator-button success">
            üíæ Save as Computed Channel
          &lt;/button>
          &lt;button id="export-ascii-btn" class="equation-evaluator-button info">
            üì• Export as ASCII
          &lt;/button>
          &lt;button id="clear-results-btn" class="equation-evaluator-button danger">
            üóëÔ∏è Clear
          &lt;/button>
        &lt;/div>
      &lt;/div>
    `;
    resultsDiv.innerHTML = html;

    // Add event listeners for save, export and clear buttons
    const saveBtn = resultsDiv.querySelector("#save-channel-btn");
    const exportBtn = resultsDiv.querySelector("#export-ascii-btn");
    const clearBtn = resultsDiv.querySelector("#clear-results-btn");

    saveBtn.onclick = () => saveComputedChannel(currentComputation, resultsDiv);
    exportBtn.onclick = () => exportAsASCII(currentComputation);
    clearBtn.onclick = () => {
      resultsDiv.innerHTML =
        '&lt;div class="equation-evaluator-empty">Enter an equation and click Execute&lt;/div>';
    };
  } catch (error) {
    resultsDiv.innerHTML = `&lt;div class="equation-evaluator-error-box">&lt;strong>Error:&lt;/strong> ${error.message}&lt;/div>`;
  }
}

function saveComputedChannel(computation, resultsDiv) {
  const channelName = `computed_${computedChannelsCounter}`;
  computedChannelsCounter++;

  // ‚úÖ REFACTORED: Store ONLY the values array in globalData.computedData
  // Metadata goes to globalCfg.computedChannels (below)
  // This matches the new format: cfg = metadata, data = values only
  globalData.computedData.push(computation.results);

  // Register in config
  // ‚úÖ AUTO-DETECT GROUP for the computed channel
  let computedChannelGroup = "G0";
  if (computation.equation) {
    const existingGroups = new Set();

    // Get groups from channelState
    if (window.channelState?.analog?.groups) {
      window.channelState.analog.groups.forEach((g) => {
        if (typeof g === "string" &amp;&amp; g.startsWith("G")) {
          const num = parseInt(g.substring(1), 10);
          if (!isNaN(num)) existingGroups.add(num);
        }
      });
    }

    if (window.channelState?.digital?.groups) {
      window.channelState.digital.groups.forEach((g) => {
        if (typeof g === "string" &amp;&amp; g.startsWith("G")) {
          const num = parseInt(g.substring(1), 10);
          if (!isNaN(num)) existingGroups.add(num);
        }
      });
    }

    // Find next available group
    let nextGroupNum = 0;
    while (existingGroups.has(nextGroupNum)) {
      nextGroupNum++;
    }
    computedChannelGroup = `G${nextGroupNum}`;
  }

  globalCfg.computedChannels.push({
    id: channelName,
    name: channelName,
    equation: computation.equation,
    unit: "Computed",
    group: computedChannelGroup,
    index: globalData.computedData.length - 1,
    stats: computation.stats,
    scaledStats: computation.scaledStats,
    scalingFactor: computation.scalingFactor,
    sampleCount: computation.results?.length || 0,
    type: "Computed",
    createdAt: Date.now(),
  });

  // üéØ CRITICAL: Broadcast new computed channel to Channel List popup if open
  if (window.__channelListWindow &amp;&amp; !window.__channelListWindow.closed) {
    try {
      const computedChannelsList = globalCfg.computedChannels || [];
      console.log("[EquationEvaluatorComponent] üì¢ Broadcasting computed channels to popup after creation:", {
        count: computedChannelsList.length,
        newChannelId: channelName,
        ids: computedChannelsList.map((ch) => ch.id),
      });

      window.__channelListWindow.postMessage(
        {
          source: "MainApp",
          type: "computed_channels_updated",
          payload: {
            computedChannels: computedChannelsList,
          },
        },
        "*"
      );
    } catch (err) {
      console.warn(
        "[EquationEvaluatorComponent] Failed to broadcast computed channels to popup:",
        err
      );
    }
  }

  // Show success message
  const successMsg = document.createElement("div");
  successMsg.style.cssText =
    "color: #ffffff; background: var(--accent-green); padding: 12px; border-radius: var(--border-radius-sm); margin-top: 10px; text-align: center; font-weight: bold; animation: fadeOut 3s ease-in-out forwards;";
  successMsg.textContent = `‚úÖ Channel saved as "${channelName}" with ${computation.results.length} samples`;

  // Add animation
  const style = document.createElement("style");
  style.textContent = `
    @keyframes fadeOut {
      0% { opacity: 1; }
      70% { opacity: 1; }
      100% { opacity: 0; }
    }
  `;
  if (!document.head.querySelector("style[data-animation]")) {
    style.setAttribute("data-animation", "true");
    document.head.appendChild(style);
  }

  resultsDiv.parentElement.insertBefore(successMsg, resultsDiv.nextSibling);

  setTimeout(() => successMsg.remove(), 3000);

  console.log(
    "[EquationEvaluator] Saved computed channel:",
    channelName,
    "with",
    computation.results.length,
    "samples"
  );
  console.log(
    "[EquationEvaluator] Total computed channels:",
    globalData.computedData.length
  );

  // Dispatch custom event so main.js can re-render charts
  const event = new CustomEvent("computedChannelSaved", {
    detail: {
      channelId: channelName,
      equation: computation.equation,
      samples: computation.results.length,
    },
  });
  window.dispatchEvent(event);
}

function showAllChannelsDialog() {
  console.log(
    "[EquationEvaluator] Showing channels dialog. globalData:",
    globalData,
    "globalCfg:",
    globalCfg
  );

  const modal = document.createElement("div");
  modal.style.cssText = `position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;`;

  const dialog = document.createElement("div");
  dialog.style.cssText = `background: white; border-radius: 8px; padding: 30px; max-width: 800px; max-height: 80vh; overflow: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3); color: #333;`;

  let html = `&lt;h2 style="margin-top: 0; color: #667eea;">Available Channels&lt;/h2>`;

  const totalSamples =
    globalData?.analogData?.[0]?.length || globalData?.analog?.[0]?.length || 0;
  console.log("[EquationEvaluator] totalSamples:", totalSamples);
  html += `&lt;p>&lt;strong>Total Samples:&lt;/strong> ${totalSamples}&lt;/p>`;

  if (globalCfg.analogChannels?.length > 0) {
    html += `&lt;h3 style="color: #667eea;">Analog Channels (${globalCfg.analogChannels.length})&lt;/h3>`;
    html += '&lt;ul style="list-style: none; padding: 0;">';
    globalCfg.analogChannels.forEach((ch, i) => {
      html += `&lt;li style="padding: 8px; background: #f0f0f0; margin-bottom: 5px; border-radius: 4px; border-left: 4px solid #667eea;">
        &lt;strong>a${i}: ${ch.id || "Analog " + i}&lt;/strong> - Unit: ${
        ch.unit || "N/A"
      } - Samples: ${totalSamples}
      &lt;/li>`;
    });
    html += "&lt;/ul>";
  }

  if (globalCfg.digitalChannels?.length > 0) {
    html += `&lt;h3 style="color: #667eea;">Digital Channels (${globalCfg.digitalChannels.length})&lt;/h3>`;
    html += '&lt;ul style="list-style: none; padding: 0;">';
    globalCfg.digitalChannels.forEach((ch, i) => {
      html += `&lt;li style="padding: 8px; background: #f0f0f0; margin-bottom: 5px; border-radius: 4px; border-left: 4px solid #667eea;">
        &lt;strong>d${i}: ${
        ch.id || "Digital " + i
      }&lt;/strong> - Samples: ${totalSamples}
      &lt;/li>`;
    });
    html += "&lt;/ul>";
  }

  // Show Computed Channels
  if (globalData.computedData?.length > 0) {
    html += `&lt;h3 style="color: #27AE60;">üßÆ Computed Channels (${globalData.computedData.length})&lt;/h3>`;
    html += '&lt;ul style="list-style: none; padding: 0;">';
    globalData.computedData.forEach((ch, i) => {
      html += `&lt;li style="padding: 12px; background: #D5F4E6; margin-bottom: 5px; border-radius: 4px; border-left: 4px solid #27AE60;">
        &lt;div>&lt;strong>c${i}: ${ch.id}&lt;/strong> - Samples: ${ch.data.length}&lt;/div>
        &lt;div style="font-size: 12px; color: #555; margin-top: 5px;">Equation: &lt;code style="background: white; padding: 2px 4px; border-radius: 2px;">${
          ch.equation
        }&lt;/code>&lt;/div>
        &lt;div style="font-size: 12px; color: #555; margin-top: 3px;">Range: [${ch.stats.min.toFixed(
          0
        )}, ${ch.stats.max.toFixed(0)}] | Avg: ${ch.stats.avg.toFixed(0)}&lt;/div>
      &lt;/li>`;
    });
    html += "&lt;/ul>";
  } else {
    html += `&lt;p style="color: #999; font-style: italic;">No computed channels yet. Create one by entering an equation and clicking "Save as Computed Channel".&lt;/p>`;
  }

  dialog.innerHTML = html;

  const closeBtn = document.createElement("button");
  closeBtn.textContent = "‚úï Close";
  closeBtn.style.cssText =
    "width: 100%; padding: 12px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 20px; font-weight: bold; font-size: 14px;";
  closeBtn.onclick = () => modal.remove();
  dialog.appendChild(closeBtn);

  modal.appendChild(dialog);
  modal.onclick = (e) => {
    if (e.target === modal) modal.remove();
  };
  document.body.appendChild(modal);
}

// Export for window access
window.computedChannelsState = computedChannelsState;

// Export helper functions for integrating computed channels with chart
export function getComputedChannels() {
  // Try to get from globalData first (for main thread access)
  if (globalData?.computedData &amp;&amp; globalData.computedData.length > 0) {
    return globalData.computedData;
  }
  return [];
}

export function getComputedChannelConfig() {
  // Try to get from globalCfg first
  if (globalCfg?.computedChannels &amp;&amp; globalCfg.computedChannels.length > 0) {
    return globalCfg.computedChannels;
  }
  return [];
}

export function getComputedChannelData(channelId) {
  // ‚úÖ REFACTORED: Get data from new structure
  // cfg.computedChannels[i] = metadata (has id)
  // data.computedData[i] = values array (no id, indexed by position)
  
  if (!globalCfg?.computedChannels || !globalData?.computedData) {
    console.warn(
      "[getComputedChannelData] No computed channels found"
    );
    return [];
  }

  // Find index by channel ID in cfg.computedChannels (metadata)
  const channelIndex = globalCfg.computedChannels.findIndex((ch) => ch.id === channelId);
  
  if (channelIndex &lt; 0) {
    console.warn(
      `[getComputedChannelData] Channel ${channelId} not found in cfg.computedChannels`
    );
    return [];
  }

  // Get values from data.computedData at same index
  const values = globalData.computedData[channelIndex];
  
  // ‚úÖ Handle both new (array of numbers) and legacy (object with .data) formats
  if (Array.isArray(values)) {
    // New format: values is directly the array
    if (typeof values[0] === 'number' || values.length === 0) {
      return values;
    }
    // Legacy format check: if it's array of objects, it's the old format
    if (values[0] &amp;&amp; typeof values[0] === 'object' &amp;&amp; 'data' in values[0]) {
      return values[0].data || [];
    }
  }
  
  // Legacy fallback: if values is an object with .data property
  if (values &amp;&amp; typeof values === 'object' &amp;&amp; !Array.isArray(values) &amp;&amp; 'data' in values) {
    return values.data || [];
  }

  console.warn(
    `[getComputedChannelData] Unexpected data format for channel ${channelId}:`,
    typeof values
  );
  return Array.isArray(values) ? values : [];
}

/**
 * Export computed channel data as ASCII format (CSV-like)
 * Generates file with headers and all data points
 */
function exportAsASCII(computation) {
  try {
    if (
      !computation ||
      !computation.results ||
      !Array.isArray(computation.results)
    ) {
      alert("‚ùå No data to export. Please execute an equation first.");
      return;
    }

    const timestamp = new Date()
      .toISOString()
      .replace(/[:.]/g, "-")
      .slice(0, -5);
    const fileName = `computed_channel_${timestamp}.csv`;

    // Build CSV content with headers
    let csvContent = "# Computed Channel Export\n";
    csvContent += `# Equation: ${computation.equation}\n`;
    csvContent += `# Timestamp: ${new Date().toISOString()}\n`;
    csvContent += `# Total Samples: ${computation.stats.count}\n`;
    csvContent += `# Valid Samples: ${computation.stats.validCount}\n`;
    csvContent += `# Min Value: ${computation.stats.min.toFixed(6)}\n`;
    csvContent += `# Max Value: ${computation.stats.max.toFixed(6)}\n`;
    csvContent += `# Average Value: ${computation.stats.avg.toFixed(6)}\n`;
    csvContent += `# Scaling Factor: ${computation.scalingFactor.toFixed(6)}\n`;
    csvContent += `# Scaled Min: ${computation.scaledStats.min.toFixed(6)}\n`;
    csvContent += `# Scaled Max: ${computation.scaledStats.max.toFixed(6)}\n`;
    csvContent += `# Scaled Average: ${computation.scaledStats.avg.toFixed(
      6
    )}\n`;
    csvContent += "\n";
    csvContent += "# Data in two formats:\n";
    csvContent += "# Column 1: Raw Values (COMTRADE format)\n";
    csvContent += "# Column 2: Scaled Values (Chart display format)\n";
    csvContent += "\n";
    csvContent += "Sample#,RawValue,ScaledValue\n";

    // Add data rows
    computation.results.forEach((rawValue, index) => {
      const scaledValue = rawValue / computation.scalingFactor;
      csvContent += `${index + 1},${rawValue.toFixed(6)},${scaledValue.toFixed(
        6
      )}\n`;
    });

    // Create blob and trigger download
    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    link.setAttribute("href", URL.createObjectURL(blob));
    link.setAttribute("download", fileName);
    link.style.visibility = "hidden";

    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    // Show success notification
    console.log(
      `[ExportASCII] ‚úÖ Exported ${computation.results.length} samples to ${fileName}`
    );
    alert(
      `‚úÖ Successfully exported!\n\nFile: ${fileName}\nSamples: ${computation.results.length}\n\nLocation: Downloads folder`
    );
  } catch (error) {
    console.error("[ExportASCII] Error:", error);
    alert(`‚ùå Export failed: ${error.message}`);
  }
}
</code></pre>
        </article>
    </section>




            </div>
            
            <footer class="footer">
                <div class="content has-text-centered">
                    <p>Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.5</a></p>
                    <p class="sidebar-created-by">
                        <a href="https://github.com/SoftwareBrothers/better-docs" target="_blank">BetterDocs theme</a> provided with <i class="fas fa-heart"></i> by
                        <a href="http://softwarebrothers.co" target="_blank">SoftwareBrothers - JavaScript Development Agency</a>
                    </p>
                </div>
            </footer>
            
        </div>
        <div id="side-nav" class="side-nav">
        </div>
    </div>
<script src="scripts/app.min.js"></script>
<script>PR.prettyPrint();</script>
<script src="scripts/linenumber.js"> </script>


</body>
</html>
