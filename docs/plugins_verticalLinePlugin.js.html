

<!DOCTYPE html>
<html lang="en">

<head>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title> plugins/verticalLinePlugin.js</title>

  <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- build/entry.js removed - not needed -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,400,700|Inconsolata,700" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
  <link type="text/css" rel="stylesheet" href="https://jmblog.github.io/color-themes-for-google-code-prettify/themes/tomorrow-night.min.css">
  <link type="text/css" rel="stylesheet" href="styles/app.min.css">
  <link type="text/css" rel="stylesheet" href="styles/iframe.css">
  <link type="text/css" rel="stylesheet" href="">
  <script async defer src="https://buttons.github.io/buttons.js"></script>

  
</head>



<body class="layout small-header">
    <div id="stickyNavbarOverlay"></div>
    

<div class="top-nav">
    <div class="inner">
        <a id="hamburger" role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
        </a>
        <div class="logo">
            
            
        </div>
        <div class="menu">
            
            <div class="navigation">
                <a
                    href="index.html"
                    class="link"
                >
                    Documentation
                </a>
                
                
                
            </div>
        </div>
    </div>
</div>
    <div id="main">
        <div
            class="sidebar "
            id="sidebarNav"
        >
            
            <nav>
                
                    <h2><a href="index.html">Documentation</a></h2><div class="category"><h3>Modules</h3><ul><li><a href="module-Context_ThemeContext.html">Context/ThemeContext</a></li><li><a href="module-analyzeGroupsAndPublish.html">analyzeGroupsAndPublish</a></li><li><a href="module-axisBuilder.html">axisBuilder</a></li><li><a href="module-axisCalculator.html">axisCalculator</a></li><li><a href="module-calculateAndPublishMaxYAxes.html">calculateAndPublishMaxYAxes</a></li><li><a href="module-chartAxisAlignment.html">chartAxisAlignment</a></li><li><a href="module-chartComponent.html">chartComponent</a></li><li><a href="module-chartManager.html">chartManager</a></li><li><a href="module-chartUpdateHelpers.html">chartUpdateHelpers</a></li><li><a href="module-components_AnalysisSidebar.html">components/AnalysisSidebar</a></li><li><a href="module-components_ChannelList.html">components/ChannelList</a></li><li><a href="module-components_ComputedChannelsSidebar.html">components/ComputedChannelsSidebar</a></li><li><a href="module-components_DeltaDrawer.html">components/DeltaDrawer</a></li><li><a href="module-components_DeltaTable.html">components/DeltaTable</a></li><li><a href="module-components_DeltaTableDataFormatter.html">components/DeltaTableDataFormatter</a></li><li><a href="module-components_DeltaTableRenderer.html">components/DeltaTableRenderer</a></li><li><a href="module-components_EquationEvaluatorInChannelList.html">components/EquationEvaluatorInChannelList</a></li><li><a href="module-components_PolarChart.html">components/PolarChart</a></li><li><a href="module-components_PolarChartCanvas.html">components/PolarChartCanvas</a></li><li><a href="module-components_ProgressBar.html">components/ProgressBar</a></li><li><a href="module-components_ResizableGroup.html">components/ResizableGroup</a></li><li><a href="module-components_SidebarResizer.html">components/SidebarResizer</a></li><li><a href="module-components_Tooltip.html">components/Tooltip</a></li><li><a href="module-components_debugPanelLite.html">components/debugPanelLite</a></li><li><a href="module-components_renderComputedChart.html">components/renderComputedChart</a></li><li><a href="module-components_renderComtradeCharts.html">components/renderComtradeCharts</a></li><li><a href="module-components_renderDigitalCharts.html">components/renderDigitalCharts</a></li><li><a href="module-components_renderSingleAnalogChart.html">components/renderSingleAnalogChart</a></li><li><a href="module-components_renderSingleDigitalChart.html">components/renderSingleDigitalChart</a></li><li><a href="module-components_setupPolarChartIntegration.html">components/setupPolarChartIntegration</a></li><li><a href="module-components_showError.html">components/showError</a></li><li><a href="module-components_verticalLineControl.html">components/verticalLineControl</a></li><li><a href="module-comtradeUtils.html">comtradeUtils</a></li><li><a href="module-createDragBar.html">createDragBar</a></li><li><a href="module-createState.html">createState</a></li><li><a href="module-domUpdateQueue.html">domUpdateQueue</a></li><li><a href="module-domUpdateQueueInit.html">domUpdateQueueInit</a></li><li><a href="module-eventListenerManager.html">eventListenerManager</a></li><li><a href="module-handleVerticalLineShortcuts.html">handleVerticalLineShortcuts</a></li><li><a href="module-initVerticalLineControl.html">initVerticalLineControl</a></li><li><a href="module-main.html">main</a></li><li><a href="module-maxYAxesStore.html">maxYAxesStore</a></li><li><a href="module-mergerWindowLauncher.html">mergerWindowLauncher</a></li><li><a href="module-plugins_autoUnitScalePlugin.html">plugins/autoUnitScalePlugin</a></li><li><a href="module-plugins_axisLinesPlugin.html">plugins/axisLinesPlugin</a></li><li><a href="module-plugins_deltaBoxPlugin.html">plugins/deltaBoxPlugin</a></li><li><a href="module-plugins_horizontalZoomPanPlugin.html">plugins/horizontalZoomPanPlugin</a></li><li><a href="module-plugins_verticalLinePlugin.html">plugins/verticalLinePlugin</a></li><li><a href="module-seriesMapper.html">seriesMapper</a></li><li><a href="module-services_computedChannels.html">services/computedChannels</a></li><li><a href="module-services_computedChannels_dataPreparation.html">services/computedChannels/dataPreparation</a></li><li><a href="module-services_computedChannels_eventHandling.html">services/computedChannels/eventHandling</a></li><li><a href="module-services_computedChannels_expressionConversion.html">services/computedChannels/expressionConversion</a></li><li><a href="module-services_computedChannels_resultProcessing.html">services/computedChannels/resultProcessing</a></li><li><a href="module-services_computedChannels_stateUpdate.html">services/computedChannels/stateUpdate</a></li><li><a href="module-services_computedChannels_validators.html">services/computedChannels/validators</a></li><li><a href="module-services_computedChannels_workerManagement.html">services/computedChannels/workerManagement</a></li><li><a href="module-setupChartDragAndDrop.html">setupChartDragAndDrop</a></li><li><a href="module-timeInterpolation.html">timeInterpolation</a></li><li><a href="module-utils_autoGroupChannels.html">utils/autoGroupChannels</a></li><li><a href="module-utils_chartDomUtils.html">utils/chartDomUtils</a></li><li><a href="module-utils_chartMetadataStore.html">utils/chartMetadataStore</a></li><li><a href="module-utils_computedChannelMetadata.html">utils/computedChannelMetadata</a></li><li><a href="module-utils_constants.html">utils/constants</a></li><li><a href="module-utils_helpers.html">utils/helpers</a></li><li><a href="module-utils_sidebarStore.html">utils/sidebarStore</a></li><li><a href="module-workers_computedChannelWorker.html">workers/computedChannelWorker</a></li></ul><h3>Classes</h3><ul><li><a href="module-components_PolarChartCanvas.PolarChartCanvas.html">PolarChartCanvas</a></li><li><a href="module-utils_computedChannelMetadata-ComputedChannelMetadata.html">ComputedChannelMetadata</a></li></ul><h3>Global</h3><ul><li><a href="global.html#IMPLEMENTATION_COMPLETE">IMPLEMENTATION_COMPLETE</a></li><li><a href="global.html#QUICK_REFERENCE">QUICK_REFERENCE</a></li><li><a href="global.html#STORAGE_CFG_KEY">STORAGE_CFG_KEY</a></li><li><a href="global.html#ZOOM_ICONS">ZOOM_ICONS</a></li><li><a href="global.html#adjustMainContent">adjustMainContent</a></li><li><a href="global.html#appendComputedChannelToStorage">appendComputedChannelToStorage</a></li><li><a href="global.html#applyZoom">applyZoom</a></li><li><a href="global.html#attachChartContainer">attachChartContainer</a></li><li><a href="global.html#attachChartEventHandlers">attachChartEventHandlers</a></li><li><a href="global.html#attachChartPlugins">attachChartPlugins</a></li><li><a href="global.html#attachComputedChartContainer">attachComputedChartContainer</a></li><li><a href="global.html#attachComputedChartEventHandlers">attachComputedChartEventHandlers</a></li><li><a href="global.html#attachComputedChartPlugins">attachComputedChartPlugins</a></li><li><a href="global.html#broadcastComputedChannelChange">broadcastComputedChannelChange</a></li><li><a href="global.html#buildChartData">buildChartData</a></li><li><a href="global.html#buildChartOptions">buildChartOptions</a></li><li><a href="global.html#buildComputedChannelLabels">buildComputedChannelLabels</a></li><li><a href="global.html#buildComputedChartOptions">buildComputedChartOptions</a></li><li><a href="global.html#buildGroupsWithAutoGrouping">buildGroupsWithAutoGrouping</a></li><li><a href="global.html#buildGroupsWithUserAssignments">buildGroupsWithUserAssignments</a></li><li><a href="global.html#buildUnitChartData">buildUnitChartData</a></li><li><a href="global.html#calculateStats">calculateStats</a></li><li><a href="global.html#chart2">chart2</a></li><li><a href="global.html#cleanupOldComputedCharts">cleanupOldComputedCharts</a></li><li><a href="global.html#clearChartsContainer">clearChartsContainer</a></li><li><a href="global.html#clearComputedChannelsFromStorage">clearComputedChannelsFromStorage</a></li><li><a href="global.html#clearExpressionCache">clearExpressionCache</a></li><li><a href="global.html#closeAnalysisDrawer">closeAnalysisDrawer</a></li><li><a href="global.html#collectChartDeltas">collectChartDeltas</a></li><li><a href="global.html#computeChartDataDimensions">computeChartDataDimensions</a></li><li><a href="global.html#createBinaryBlob">createBinaryBlob</a></li><li><a href="global.html#createChannelList">createChannelList</a></li><li><a href="global.html#createChartMetadata">createChartMetadata</a></li><li><a href="global.html#createChartOptions">createChartOptions</a></li><li><a href="global.html#createComputedChartMetadata">createComputedChartMetadata</a></li><li><a href="global.html#createComputedClickHandler">createComputedClickHandler</a></li><li><a href="global.html#createComputedMousemoveHandler">createComputedMousemoveHandler</a></li><li><a href="global.html#createDigitalFillPlugin">createDigitalFillPlugin</a></li><li><a href="global.html#createGroupDragBar">createGroupDragBar</a></li><li><a href="global.html#createMousemoveHandler">createMousemoveHandler</a></li><li><a href="global.html#createScopeTemplate">createScopeTemplate</a></li><li><a href="global.html#createState">createState</a></li><li><a href="global.html#createVerticalLineClickHandler">createVerticalLineClickHandler</a></li><li><a href="global.html#createZoomControlsHTML">createZoomControlsHTML</a></li><li><a href="global.html#debounce">debounce</a></li><li><a href="global.html#deleteComputedChannelFromStorage">deleteComputedChannelFromStorage</a></li><li><a href="global.html#encodeFloat64">encodeFloat64</a></li><li><a href="global.html#encodeInt32">encodeInt32</a></li><li><a href="global.html#evaluateExpression">evaluateExpression</a></li><li><a href="global.html#exportAllChannelsAsCSV">exportAllChannelsAsCSV</a></li><li><a href="global.html#exportComputedChannelsAsCSV">exportComputedChannelsAsCSV</a></li><li><a href="global.html#extractChannelMetadata">extractChannelMetadata</a></li><li><a href="global.html#extractChannelNameFromEquation">extractChannelNameFromEquation</a></li><li><a href="global.html#extractGroupId">extractGroupId</a></li><li><a href="global.html#extractMathExpression">extractMathExpression</a></li><li><a href="global.html#filterGroupsWithChannels">filterGroupsWithChannels</a></li><li><a href="global.html#filterUnassignedComputedChannels">filterUnassignedComputedChannels</a></li><li><a href="global.html#filterValidIndices">filterValidIndices</a></li><li><a href="global.html#formatEquationForLatex">formatEquationForLatex</a></li><li><a href="global.html#formatScaledValue">formatScaledValue</a></li><li><a href="global.html#generateCFGContentBinary32">generateCFGContentBinary32</a></li><li><a href="global.html#generateCFGContentBinary64">generateCFGContentBinary64</a></li><li><a href="global.html#generateCFGContentFloat32">generateCFGContentFloat32</a></li><li><a href="global.html#generateCFGContentFloat64">generateCFGContentFloat64</a></li><li><a href="global.html#generateDATContentBinary32">generateDATContentBinary32</a></li><li><a href="global.html#generateDATContentBinary64">generateDATContentBinary64</a></li><li><a href="global.html#generateDATContentFloat32">generateDATContentFloat32</a></li><li><a href="global.html#generateDATContentFloat64">generateDATContentFloat64</a></li><li><a href="global.html#getCacheStats">getCacheStats</a></li><li><a href="global.html#getChannelByDisplayName">getChannelByDisplayName</a></li><li><a href="global.html#getChannelMetadata">getChannelMetadata</a></li><li><a href="global.html#getChannelsForFile">getChannelsForFile</a></li><li><a href="global.html#getCompiledExpression">getCompiledExpression</a></li><li><a href="global.html#getComputedChannelById">getComputedChannelById</a></li><li><a href="global.html#getComputedChannelStorageMetadata">getComputedChannelStorageMetadata</a></li><li><a href="global.html#getComputedChannelsState">getComputedChannelsState</a></li><li><a href="global.html#getElementWidth">getElementWidth</a></li><li><a href="global.html#getFileIndexForTime">getFileIndexForTime</a></li><li><a href="global.html#getOriginalChannelName">getOriginalChannelName</a></li><li><a href="global.html#getSampleIndexInFile">getSampleIndexInFile</a></li><li><a href="global.html#getZoomLevel">getZoomLevel</a></li><li><a href="global.html#groupChannelsByUnit">groupChannelsByUnit</a></li><li><a href="global.html#handleComputedVerticalLineAddition">handleComputedVerticalLineAddition</a></li><li><a href="global.html#handleVerticalLineAddition">handleVerticalLineAddition</a></li><li><a href="global.html#hasStoredComputedChannels">hasStoredComputedChannels</a></li><li><a href="global.html#initComputedChannelsState">initComputedChannelsState</a></li><li><a href="global.html#initializeChartInstance">initializeChartInstance</a></li><li><a href="global.html#initializeComputedChartInstance">initializeComputedChartInstance</a></li><li><a href="global.html#initializeSidebarChannels">initializeSidebarChannels</a></li><li><a href="global.html#initializeZoomControls">initializeZoomControls</a></li><li><a href="global.html#injectZoomControls">injectZoomControls</a></li><li><a href="global.html#isMathJaxLoaded">isMathJaxLoaded</a></li><li><a href="global.html#listenForComputedChannelChanges">listenForComputedChannelChanges</a></li><li><a href="global.html#loadComputedChannelsForGroup">loadComputedChannelsForGroup</a></li><li><a href="global.html#loadComputedChannelsFromStorage">loadComputedChannelsFromStorage</a></li><li><a href="global.html#loadMathJax">loadMathJax</a></li><li><a href="global.html#mathJaxPromise">mathJaxPromise</a></li><li><a href="global.html#measurePerformance">measurePerformance</a></li><li><a href="global.html#mergeAnalogAndComputedMetadata">mergeAnalogAndComputedMetadata</a></li><li><a href="global.html#mergeAnalogChannels">mergeAnalogChannels</a></li><li><a href="global.html#mergeComtradeFilesSetsSequential">mergeComtradeFilesSetsSequential</a></li><li><a href="global.html#mergeDigitalChannels">mergeDigitalChannels</a></li><li><a href="global.html#mergeTimeArraysSequential">mergeTimeArraysSequential</a></li><li><a href="global.html#openAnalysisDrawer">openAnalysisDrawer</a></li><li><a href="global.html#openBothSidebars">openBothSidebars</a></li><li><a href="global.html#openDeltaWindow">openDeltaWindow</a></li><li><a href="global.html#openPhasorDiagram">openPhasorDiagram</a></li><li><a href="global.html#prepareChartDataContext">prepareChartDataContext</a></li><li><a href="global.html#processEquationInput">processEquationInput</a></li><li><a href="global.html#renameChannelWithPrefix">renameChannelWithPrefix</a></li><li><a href="global.html#renderChannelLabelContainer">renderChannelLabelContainer</a></li><li><a href="global.html#renderComputedChannels">renderComputedChannels</a></li><li><a href="global.html#renderLatex">renderLatex</a></li><li><a href="global.html#resetZoom">resetZoom</a></li><li><a href="global.html#resizeChartsToContainers">resizeChartsToContainers</a></li><li><a href="global.html#resolveGroupIndices">resolveGroupIndices</a></li><li><a href="global.html#resolveTimeArray">resolveTimeArray</a></li><li><a href="global.html#saveComputedChannelsToStorage">saveComputedChannelsToStorage</a></li><li><a href="global.html#setZoomLevel">setZoomLevel</a></li><li><a href="global.html#setupMobileSidebar">setupMobileSidebar</a></li><li><a href="global.html#showChannelListWindow">showChannelListWindow</a></li><li><a href="global.html#showFileInfo">showFileInfo</a></li><li><a href="global.html#subscribeChartUpdates">subscribeChartUpdates</a></li><li><a href="global.html#syncComputedChannelsWithParent">syncComputedChannelsWithParent</a></li><li><a href="global.html#toggleChartsVisibility">toggleChartsVisibility</a></li><li><a href="global.html#updateComputedChannelGroupInStorage">updateComputedChannelGroupInStorage</a></li><li><a href="global.html#updateComputedChannelInStorage">updateComputedChannelInStorage</a></li><li><a href="global.html#updateFileInfo">updateFileInfo</a></li><li><a href="global.html#updateMainZoomPosition">updateMainZoomPosition</a></li><li><a href="global.html#updateStatsCards">updateStatsCards</a></li><li><a href="global.html#updateZoomDisplay">updateZoomDisplay</a></li><li><a href="global.html#validateChannelName">validateChannelName</a></li><li><a href="global.html#validateGroupIndices">validateGroupIndices</a></li><li><a href="global.html#wrapChartInSection">wrapChartInSection</a></li><li><a href="global.html#zoomIn">zoomIn</a></li><li><a href="global.html#zoomOut">zoomOut</a></li></ul></div>
                
            </nav>
        </div>
        <div class="core" id="main-content-wrapper">
            <div class="content">
                <header class="page-title">
                    <p>Source</p>
                    <h1>plugins/verticalLinePlugin.js</h1>
                </header>
                



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file verticalLinePlugin.js
 * @module plugins/verticalLinePlugin
 * 
 * @description
 * &lt;h3>uPlot Plugin: Vertical Line &amp; Crosshair Points&lt;/h3>
 * 
 * &lt;p>Enables placing, dragging, and visualizing vertical measurement lines on uPlot charts.
 * Lines are synchronized across all charts and display crosshair points where they intersect
 * series data. Used for delta calculations and time-point analysis.&lt;/p>
 * 
 * &lt;h4>Design Philosophy&lt;/h4>
 * &lt;table>
 *   &lt;tr>&lt;th>Principle&lt;/th>&lt;th>Description&lt;/th>&lt;/tr>
 *   &lt;tr>&lt;td>Reactive State&lt;/td>&lt;td>Lines stored in verticalLinesXState, auto-syncs across charts&lt;/td>&lt;/tr>
 *   &lt;tr>&lt;td>Drag Support&lt;/td>&lt;td>Lines can be dragged to new positions with mouse&lt;/td>&lt;/tr>
 *   &lt;tr>&lt;td>Event Capture&lt;/td>&lt;td>Uses capture phase to prevent selection box during drag&lt;/td>&lt;/tr>
 *   &lt;tr>&lt;td>Debounced Updates&lt;/td>&lt;td>Delta calculations debounced to prevent UI freezing&lt;/td>&lt;/tr>
 * &lt;/table>
 * 
 * &lt;h4>Key Features&lt;/h4>
 * &lt;ul>
 *   &lt;li>&lt;strong>Add Lines&lt;/strong> â€” Alt+1 adds vertical line at cursor position&lt;/li>
 *   &lt;li>&lt;strong>Drag Lines&lt;/strong> â€” Click and drag to reposition lines&lt;/li>
 *   &lt;li>&lt;strong>Crosshair Points&lt;/strong> â€” Colored dots at series intersections&lt;/li>
 *   &lt;li>&lt;strong>Line Colors&lt;/strong> â€” Configurable colors from crosshairColors palette&lt;/li>
 *   &lt;li>&lt;strong>Chart Sync&lt;/strong> â€” All charts show same vertical lines&lt;/li>
 *   &lt;li>&lt;strong>Delta Display&lt;/strong> â€” Triggers delta calculations on line change&lt;/li>
 * &lt;/ul>
 * 
 * &lt;h4>Keyboard Shortcuts&lt;/h4>
 * &lt;table>
 *   &lt;tr>&lt;th>Shortcut&lt;/th>&lt;th>Action&lt;/th>&lt;/tr>
 *   &lt;tr>&lt;td>Alt+0&lt;/td>&lt;td>Clear all vertical lines&lt;/td>&lt;/tr>
 *   &lt;tr>&lt;td>Alt+1&lt;/td>&lt;td>Add vertical line at cursor&lt;/td>&lt;/tr>
 *   &lt;tr>&lt;td>Alt+2&lt;/td>&lt;td>Go to previous line&lt;/td>&lt;/tr>
 *   &lt;tr>&lt;td>Alt+3&lt;/td>&lt;td>Go to next line&lt;/td>&lt;/tr>
 *   &lt;tr>&lt;td>Alt+4&lt;/td>&lt;td>Delete current line&lt;/td>&lt;/tr>
 * &lt;/table>
 * 
 * @see {@link module:components/handleVerticalLineShortcuts} - Keyboard handler
 * @see {@link module:utils/calculateDeltas} - Delta calculation utilities
 * 
 * @example
 * import verticalLinePlugin from './plugins/verticalLinePlugin.js';
 * 
 * const opts = {
 *   plugins: [
 *     verticalLinePlugin(verticalLinesXState, getCharts, {
 *       lineColors: ['red', 'blue', 'green'],
 *       lineWidth: 2,
 *       pointRadius: 5
 *     })
 *   ]
 * };
 * 
 * @mermaid
 * graph TD
 *     subgraph User_Actions
 *         A[Alt+1: Add Line] --> B[Get Cursor X Position]
 *         B --> C[Push to verticalLinesXState]
 *         
 *         D[Mouse Down on Line] --> E[Start Drag]
 *         E --> F[Track Mouse Move]
 *         F --> G[Update Line Position]
 *         G --> H[Mouse Up: End Drag]
 *     end
 *     
 *     subgraph Drawing_Hooks
 *         I[draw hook] --> J[Clear Previous Lines]
 *         J --> K[For Each Line in State]
 *         K --> L[Draw Vertical Line]
 *         L --> M[Find Series Intersections]
 *         M --> N[Draw Crosshair Points]
 *         N --> K
 *     end
 *     
 *     subgraph State_Sync
 *         O[verticalLinesXState Changes] --> P[Subscribe Callback]
 *         P --> Q[Trigger Chart Redraw]
 *         Q --> R[Update Delta Calculations]
 *     end
 *     
 *     style A fill:#4CAF50,color:white
 *     style L fill:#2196F3,color:white
 *     style R fill:#FF9800,color:white
 */

import { crosshairColors } from "../utils/constants.js";
import { getNearestIndex } from "../utils/helpers.js";
import { debounce } from "../utils/computedChannelOptimization.js";

function getEventXValue(u, e) {
  const overlay = u.over;
  if (!overlay) {
    return u.posToVal(e.offsetX, "x");
  }

  const rect = overlay.getBoundingClientRect();
  const x = e.clientX - rect.left;
  return u.posToVal(x, "x");
}

export default function verticalLinePlugin(
  verticalLinesXState,
  getCharts = null,
  options = {}
) {
  let isDragging = false;
  let draggedLineIndex = null;
  let overlayRef = null;
  let unsubscribe = null;
  const lineColors = options.lineColors || crosshairColors;
  const lineWidth = options.lineWidth || 2;
  const pointRadius = options.pointRadius || 5;
  const labelFormatter =
    options.labelFormatter ||
    ((color) => color.charAt(0).toUpperCase() + color.slice(1));

  function isHoveringLine(u, xVal, hoverRadius) {
    const lines = verticalLinesXState.asArray();
    return lines.some((xData) => Math.abs(xVal - xData) &lt; hoverRadius);
  }

  return {
    hooks: {
      init: [
        (u) => {
          const overlay = u.over;
          overlayRef = overlay;

          // âœ… Debounce the update function to prevent multiple rapid calls
          const debouncedDeltaUpdate = debounce(async () => {
            if (getCharts) {
              const charts = getCharts();
              const { collectChartDeltas } = await import(
                "../utils/calculateDeltas.js"
              );
              const allDeltaData = [];

              // âœ… Collect all chart deltas in ONE batch
              for (const chart of charts) {
                try {
                  const chartDeltas = collectChartDeltas(
                    verticalLinesXState.asArray(),
                    chart,
                    "microseconds"
                  );
                  if (chartDeltas.length > 0) {
                    allDeltaData.push(...chartDeltas);
                  }
                } catch (error) {
                  console.error(
                    "[verticalLinePlugin] Error collecting chart deltas:",
                    error
                  );
                }
              }

              if (allDeltaData.length > 0) {
                try {
                  const { deltaWindow } = await import("../main.js");
                  const linesLength =
                    verticalLinesXState?.asArray?.()?.length || 0;
                  if (deltaWindow) {
                    console.log(
                      "[verticalLinePlugin] ðŸ”„ Calling deltaWindow.update() with debounce"
                    );
                    deltaWindow.update(allDeltaData, linesLength);
                  }
                } catch (e) {
                  console.error(
                    "[verticalLinePlugin] Error updating delta window:",
                    e
                  );
                }
              }
            }
          }, 100); // âœ… 100ms debounce to batch rapid state changes

          // Subscribe to state changes with debounced update
          if (
            verticalLinesXState &amp;&amp;
            typeof verticalLinesXState.subscribe === "function"
          ) {
            unsubscribe = verticalLinesXState.subscribe(async () => {
              console.log(
                "[verticalLinePlugin] Subscription triggered, calling debounced update"
              );
              debouncedDeltaUpdate();
            });
          }

          // âœ… CRITICAL: Attach handlers in CAPTURE phase (true) to run BEFORE uPlot's handlers
          const handleMouseDown = (e) => {
            if (!u || !u.scales || !u.data) return;

            const lines = verticalLinesXState.asArray();
            const xVal = getEventXValue(u, e);
            const hoverRadius = (u.scales.x.max - u.scales.x.min) * 0.01;

            for (let idx = 0; idx &lt; lines.length; idx++) {
              const xData = lines[idx];
              if (Math.abs(xVal - xData) &lt; hoverRadius) {
                isDragging = true;
                draggedLineIndex = idx;

                // âœ… STOP event from reaching uPlot's handlers
                e.stopPropagation();
                e.stopImmediatePropagation();
                e.preventDefault();

                u.redraw();
                return;
              }
            }
          };

          const handleMouseMove = (e) => {
            if (!u || !u.scales) return;

            const xVal = getEventXValue(u, e);
            const hoverRadius = (u.scales.x.max - u.scales.x.min) * 0.005;
            const isHovering = isHoveringLine(u, xVal, hoverRadius);

            overlay.style.cursor = isHovering ? "ew-resize" : "default";

            if (isDragging) {
              // âœ… BLOCK event during drag to prevent selection box
              e.stopPropagation();
              e.stopImmediatePropagation();
              e.preventDefault();

              verticalLinesXState[draggedLineIndex] = xVal;

              // âœ… IMMEDIATELY redraw the current chart being dragged for smooth movement
              u.redraw();

              // Sync with other charts
              if (getCharts) {
                const charts = getCharts();
                (async () => {
                  for (let chart of charts) {
                    if (chart &amp;&amp; chart !== u &amp;&amp; chart.redraw) {
                      chart.redraw();
                    }
                  }

                  // Collect deltas
                  const { collectChartDeltas } = await import(
                    "../utils/calculateDeltas.js"
                  );
                  const allDeltaData = [];

                  for (const chart of charts) {
                    const chartDeltas = collectChartDeltas(
                      verticalLinesXState.asArray(),
                      chart,
                      "microseconds"
                    );
                    if (chartDeltas.length > 0) {
                      allDeltaData.push(...chartDeltas);
                    }
                  }

                  const linesArray =
                    verticalLinesXState?.value || verticalLinesXState || [];
                  const linesLength = Array.isArray(linesArray)
                    ? linesArray.length
                    : 0;

                  // Show drawer whenever vertical lines exist (even if just 1)
                  if (linesLength > 0) {
                    try {
                      const { deltaWindow } = await import("../main.js");
                      if (deltaWindow) {
                        deltaWindow.show(); // Show the drawer when dragging lines
                        deltaWindow.update(allDeltaData, linesLength);
                      }
                    } catch (e) {
                      // Silent fail
                    }
                  }
                })();
              }
            }
          };

          const handleMouseUp = (e) => {
            if (isDragging) {
              isDragging = false;
              draggedLineIndex = null;
              overlay.style.cursor = "default";

              // âœ… BLOCK event to prevent unwanted selection
              e.stopPropagation();
              e.stopImmediatePropagation();
              e.preventDefault();
            }
          };

          // âœ… Use CAPTURE phase (true) to intercept events BEFORE uPlot's bubble phase
          overlay.addEventListener("mousedown", handleMouseDown, true);
          overlay.addEventListener("mousemove", handleMouseMove, true);
          overlay.addEventListener("mouseup", handleMouseUp, true);

          overlay.addEventListener(
            "mouseleave",
            () => {
              if (isDragging) {
                isDragging = false;
                draggedLineIndex = null;
                overlay.style.cursor = "default";
              }
            },
            true
          );
        },
      ],
      draw: [
        (u) => {
          if (!verticalLinesXState) return;
          if (!u.data || !u.data[0] || u.data[0].length === 0) return;

          const ctx = u.ctx;
          const { top, height } = u.bbox;

          if (!top || !height || !ctx) return;

          const lines =
            typeof verticalLinesXState.asArray === "function"
              ? verticalLinesXState.asArray()
              : Array.isArray(verticalLinesXState)
              ? verticalLinesXState
              : verticalLinesXState.value || [];

          ctx.save();
          ctx.lineWidth = lineWidth;

          lines.forEach((xData, idx) => {
            try {
              const nearestIdx = getNearestIndex(u.data[0], xData);

              if (
                !Number.isFinite(nearestIdx) ||
                nearestIdx &lt; 0 ||
                nearestIdx >= u.data[0].length
              ) {
                return;
              }

              const xPos = u.valToPos(u.data[0][nearestIdx], "x", true);
              const color = lineColors[idx % lineColors.length];

              // Draw vertical line
              ctx.strokeStyle = color;
              ctx.globalAlpha = 1;
              ctx.beginPath();
              ctx.moveTo(xPos, top);
              ctx.lineTo(xPos, top + height);
              ctx.stroke();

              // Draw crosshair points
              u.data.slice(1).forEach((series, seriesIdx) => {
                const actualIdx = seriesIdx + 1;
                if (!u.series[actualIdx]) return;

                const interpolatedValue = getInterpolatedValue(
                  u.data[0],
                  series,
                  xData,
                  nearestIdx
                );

                const yPos = u.valToPos(interpolatedValue, "y", true);
                ctx.beginPath();
                ctx.arc(xPos, yPos, pointRadius, 0, 2 * Math.PI);
                ctx.fillStyle = color;
                ctx.globalAlpha = 1;
                ctx.fill();
              });

              // Draw label
              ctx.font = "bold 12px Arial";
              ctx.fillStyle = color;
              ctx.globalAlpha = 1;
              ctx.fillText(labelFormatter(color), xPos + 5, u.bbox.top + 15);
            } catch (err) {
              console.error(
                "[verticalLinePlugin] Error drawing line:",
                err.message
              );
            }
          });
          ctx.restore();
        },
      ],
      destroy: [
        (u) => {
          if (unsubscribe) unsubscribe();
          if (overlayRef) {
            overlayRef.replaceWith(overlayRef.cloneNode(true));
          }
        },
      ],
    },
  };
}

// Helper function for value interpolation
function getInterpolatedValue(xData, yData, targetX, nearestIdx) {
  if (xData[nearestIdx] === targetX) {
    return yData[nearestIdx];
  }

  let idx1 = nearestIdx;
  let idx2 = nearestIdx;

  if (targetX > xData[nearestIdx] &amp;&amp; nearestIdx &lt; xData.length - 1) {
    idx2 = nearestIdx + 1;
  } else if (targetX &lt; xData[nearestIdx] &amp;&amp; nearestIdx > 0) {
    idx1 = nearestIdx - 1;
    idx2 = nearestIdx;
  }

  const x1 = xData[idx1];
  const x2 = xData[idx2];
  const y1 = yData[idx1];
  const y2 = yData[idx2];

  if (x1 === x2 || typeof y1 !== "number" || typeof y2 !== "number") {
    return yData[nearestIdx];
  }

  const interpolated = y1 + ((y2 - y1) * (targetX - x1)) / (x2 - x1);
  return interpolated;
}
</code></pre>
        </article>
    </section>




            </div>
            
            <footer class="footer">
                <div class="content has-text-centered">
                    <p>Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.5</a></p>
                    <p class="sidebar-created-by">
                        <a href="https://github.com/SoftwareBrothers/better-docs" target="_blank">BetterDocs theme</a> provided with <i class="fas fa-heart"></i> by
                        <a href="http://softwarebrothers.co" target="_blank">SoftwareBrothers - JavaScript Development Agency</a>
                    </p>
                </div>
            </footer>
            
        </div>
        <div id="side-nav" class="side-nav">
        </div>
    </div>
<script src="scripts/app.min.js"></script>
<script>PR.prettyPrint();</script>
<script src="scripts/linenumber.js"> </script>


</body>
</html>
