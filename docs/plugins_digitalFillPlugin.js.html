

<!DOCTYPE html>
<html lang="en">

<head>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title> plugins/digitalFillPlugin.js</title>

  <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- build/entry.js removed - not needed -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,400,700|Inconsolata,700" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
  <link type="text/css" rel="stylesheet" href="https://jmblog.github.io/color-themes-for-google-code-prettify/themes/tomorrow-night.min.css">
  <link type="text/css" rel="stylesheet" href="styles/app.min.css">
  <link type="text/css" rel="stylesheet" href="styles/iframe.css">
  <link type="text/css" rel="stylesheet" href="">
  <script async defer src="https://buttons.github.io/buttons.js"></script>

  
</head>



<body class="layout small-header">
    <div id="stickyNavbarOverlay"></div>
    

<div class="top-nav">
    <div class="inner">
        <a id="hamburger" role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
        </a>
        <div class="logo">
            
            
        </div>
        <div class="menu">
            
            <div class="navigation">
                <a
                    href="index.html"
                    class="link"
                >
                    Documentation
                </a>
                
                
                
            </div>
        </div>
    </div>
</div>
    <div id="main">
        <div
            class="sidebar "
            id="sidebarNav"
        >
            
            <nav>
                
                    <h2><a href="index.html">Documentation</a></h2><div class="category"><h3>Modules</h3><ul><li><a href="module-analyzeGroupsAndPublish.html">analyzeGroupsAndPublish</a></li><li><a href="module-axisBuilder.html">axisBuilder</a></li><li><a href="module-axisCalculator.html">axisCalculator</a></li><li><a href="module-calculateAndPublishMaxYAxes.html">calculateAndPublishMaxYAxes</a></li><li><a href="module-chartAxisAlignment.html">chartAxisAlignment</a></li><li><a href="module-chartComponent.html">chartComponent</a></li><li><a href="module-chartManager.html">chartManager</a></li><li><a href="module-chartUpdateHelpers.html">chartUpdateHelpers</a></li><li><a href="module-components_renderComputedChart.html">components/renderComputedChart</a></li><li><a href="module-components_renderComtradeCharts.html">components/renderComtradeCharts</a></li><li><a href="module-components_renderSingleAnalogChart.html">components/renderSingleAnalogChart</a></li><li><a href="module-components_renderSingleDigitalChart.html">components/renderSingleDigitalChart</a></li><li><a href="module-comtradeUtils.html">comtradeUtils</a></li><li><a href="module-createDragBar.html">createDragBar</a></li><li><a href="module-createState.html">createState</a></li><li><a href="module-domUpdateQueue.html">domUpdateQueue</a></li><li><a href="module-domUpdateQueueInit.html">domUpdateQueueInit</a></li><li><a href="module-eventListenerManager.html">eventListenerManager</a></li><li><a href="module-handleVerticalLineShortcuts.html">handleVerticalLineShortcuts</a></li><li><a href="module-initVerticalLineControl.html">initVerticalLineControl</a></li><li><a href="module-main.html">main</a></li><li><a href="module-maxYAxesStore.html">maxYAxesStore</a></li><li><a href="module-mergerWindowLauncher.html">mergerWindowLauncher</a></li><li><a href="module-seriesMapper.html">seriesMapper</a></li><li><a href="module-services_computedChannels.html">services/computedChannels</a></li><li><a href="module-services_computedChannels_dataPreparation.html">services/computedChannels/dataPreparation</a></li><li><a href="module-services_computedChannels_eventHandling.html">services/computedChannels/eventHandling</a></li><li><a href="module-services_computedChannels_expressionConversion.html">services/computedChannels/expressionConversion</a></li><li><a href="module-services_computedChannels_resultProcessing.html">services/computedChannels/resultProcessing</a></li><li><a href="module-services_computedChannels_stateUpdate.html">services/computedChannels/stateUpdate</a></li><li><a href="module-services_computedChannels_validators.html">services/computedChannels/validators</a></li><li><a href="module-services_computedChannels_workerManagement.html">services/computedChannels/workerManagement</a></li><li><a href="module-setupChartDragAndDrop.html">setupChartDragAndDrop</a></li><li><a href="module-timeInterpolation.html">timeInterpolation</a></li><li><a href="module-utils_autoGroupChannels.html">utils/autoGroupChannels</a></li><li><a href="module-utils_computedChannelMetadata.html">utils/computedChannelMetadata</a></li><li><a href="module-verticalLineControl.html">verticalLineControl</a></li><li><a href="module-workers_computedChannelWorker.html">workers/computedChannelWorker</a></li></ul><h3>Classes</h3><ul><li><a href="PolarChart.html">PolarChart</a></li><li><a href="PolarChartCanvas.html">PolarChartCanvas</a></li><li><a href="SidebarStore.html">SidebarStore</a></li><li><a href="module-utils_computedChannelMetadata-ComputedChannelMetadata.html">ComputedChannelMetadata</a></li></ul><h3>Global</h3><ul><li><a href="global.html#IMPLEMENTATION_COMPLETE">IMPLEMENTATION_COMPLETE</a></li><li><a href="global.html#QUICK_REFERENCE">QUICK_REFERENCE</a></li><li><a href="global.html#STORAGE_CFG_KEY">STORAGE_CFG_KEY</a></li><li><a href="global.html#adjustMainContent">adjustMainContent</a></li><li><a href="global.html#appendComputedChannelToStorage">appendComputedChannelToStorage</a></li><li><a href="global.html#attachChartContainer">attachChartContainer</a></li><li><a href="global.html#attachChartEventHandlers">attachChartEventHandlers</a></li><li><a href="global.html#attachChartPlugins">attachChartPlugins</a></li><li><a href="global.html#attachComputedChartContainer">attachComputedChartContainer</a></li><li><a href="global.html#attachComputedChartEventHandlers">attachComputedChartEventHandlers</a></li><li><a href="global.html#attachComputedChartPlugins">attachComputedChartPlugins</a></li><li><a href="global.html#axisLinesPlugin">axisLinesPlugin</a></li><li><a href="global.html#broadcastComputedChannelChange">broadcastComputedChannelChange</a></li><li><a href="global.html#buildChartData">buildChartData</a></li><li><a href="global.html#buildChartOptions">buildChartOptions</a></li><li><a href="global.html#buildComputedChannelLabels">buildComputedChannelLabels</a></li><li><a href="global.html#buildComputedChartOptions">buildComputedChartOptions</a></li><li><a href="global.html#buildGroupsWithAutoGrouping">buildGroupsWithAutoGrouping</a></li><li><a href="global.html#buildGroupsWithUserAssignments">buildGroupsWithUserAssignments</a></li><li><a href="global.html#buildTableBody">buildTableBody</a></li><li><a href="global.html#buildTableHTML">buildTableHTML</a></li><li><a href="global.html#buildTableHeader">buildTableHeader</a></li><li><a href="global.html#buildUnitChartData">buildUnitChartData</a></li><li><a href="global.html#calculateStats">calculateStats</a></li><li><a href="global.html#chart2">chart2</a></li><li><a href="global.html#cleanupOldComputedCharts">cleanupOldComputedCharts</a></li><li><a href="global.html#clearChartsContainer">clearChartsContainer</a></li><li><a href="global.html#clearComputedChannelsFromStorage">clearComputedChannelsFromStorage</a></li><li><a href="global.html#clearExpressionCache">clearExpressionCache</a></li><li><a href="global.html#closeAnalysisDrawer">closeAnalysisDrawer</a></li><li><a href="global.html#collectChartDeltas">collectChartDeltas</a></li><li><a href="global.html#computeChartDataDimensions">computeChartDataDimensions</a></li><li><a href="global.html#convertLatexToMathJs">convertLatexToMathJs</a></li><li><a href="global.html#convertLatexToPlainText">convertLatexToPlainText</a></li><li><a href="global.html#createAnalogChannelGroupMap">createAnalogChannelGroupMap</a></li><li><a href="global.html#createBinaryBlob">createBinaryBlob</a></li><li><a href="global.html#createChannelItem">createChannelItem</a></li><li><a href="global.html#createChannelList">createChannelList</a></li><li><a href="global.html#createChartContainer">createChartContainer</a></li><li><a href="global.html#createChartMetadata">createChartMetadata</a></li><li><a href="global.html#createChartOptions">createChartOptions</a></li><li><a href="global.html#createComputedChannelsSidebar">createComputedChannelsSidebar</a></li><li><a href="global.html#createComputedChartMetadata">createComputedChartMetadata</a></li><li><a href="global.html#createComputedClickHandler">createComputedClickHandler</a></li><li><a href="global.html#createComputedMousemoveHandler">createComputedMousemoveHandler</a></li><li><a href="global.html#createDeltaTableRenderer">createDeltaTableRenderer</a></li><li><a href="global.html#createDigitalFillPlugin">createDigitalFillPlugin</a></li><li><a href="global.html#createGroupDragBar">createGroupDragBar</a></li><li><a href="global.html#createMousemoveHandler">createMousemoveHandler</a></li><li><a href="global.html#createProgressBar">createProgressBar</a></li><li><a href="global.html#createScopeTemplate">createScopeTemplate</a></li><li><a href="global.html#createSidebarResizer">createSidebarResizer</a></li><li><a href="global.html#createSimpleChannelList">createSimpleChannelList</a></li><li><a href="global.html#createSimpleContainer">createSimpleContainer</a></li><li><a href="global.html#createState">createState</a></li><li><a href="global.html#createTooltip">createTooltip</a></li><li><a href="global.html#createVerticalLineClickHandler">createVerticalLineClickHandler</a></li><li><a href="global.html#debounce">debounce</a></li><li><a href="global.html#detectGroupFromExpression">detectGroupFromExpression</a></li><li><a href="global.html#encodeFloat64">encodeFloat64</a></li><li><a href="global.html#encodeInt32">encodeInt32</a></li><li><a href="global.html#evaluateAndSaveComputedChannel">evaluateAndSaveComputedChannel</a></li><li><a href="global.html#evaluateExpression">evaluateExpression</a></li><li><a href="global.html#exportAllChannelsAsCSV">exportAllChannelsAsCSV</a></li><li><a href="global.html#exportAllComputedChannels">exportAllComputedChannels</a></li><li><a href="global.html#exportComputedChannelAsASCII">exportComputedChannelAsASCII</a></li><li><a href="global.html#exportComputedChannelAsCFGDAT">exportComputedChannelAsCFGDAT</a></li><li><a href="global.html#exportComputedChannelsAsCSV">exportComputedChannelsAsCSV</a></li><li><a href="global.html#extractChannelMetadata">extractChannelMetadata</a></li><li><a href="global.html#extractChannelNameFromEquation">extractChannelNameFromEquation</a></li><li><a href="global.html#extractGroupId">extractGroupId</a></li><li><a href="global.html#extractMathExpression">extractMathExpression</a></li><li><a href="global.html#filterGroupsWithChannels">filterGroupsWithChannels</a></li><li><a href="global.html#filterIndicesWithData">filterIndicesWithData</a></li><li><a href="global.html#filterTableRows">filterTableRows</a></li><li><a href="global.html#filterUnassignedComputedChannels">filterUnassignedComputedChannels</a></li><li><a href="global.html#filterValidIndices">filterValidIndices</a></li><li><a href="global.html#formatEquationForLatex">formatEquationForLatex</a></li><li><a href="global.html#formatScaledValue">formatScaledValue</a></li><li><a href="global.html#formatTableData">formatTableData</a></li><li><a href="global.html#generateCFGContent">generateCFGContent</a></li><li><a href="global.html#generateCFGContentBatch">generateCFGContentBatch</a></li><li><a href="global.html#generateCFGContentBinary32">generateCFGContentBinary32</a></li><li><a href="global.html#generateCFGContentBinary64">generateCFGContentBinary64</a></li><li><a href="global.html#generateCFGContentFloat32">generateCFGContentFloat32</a></li><li><a href="global.html#generateCFGContentFloat64">generateCFGContentFloat64</a></li><li><a href="global.html#generateDATContent">generateDATContent</a></li><li><a href="global.html#generateDATContentBatch">generateDATContentBatch</a></li><li><a href="global.html#generateDATContentBinary32">generateDATContentBinary32</a></li><li><a href="global.html#generateDATContentBinary64">generateDATContentBinary64</a></li><li><a href="global.html#generateDATContentFloat32">generateDATContentFloat32</a></li><li><a href="global.html#generateDATContentFloat64">generateDATContentFloat64</a></li><li><a href="global.html#generateUniqueComputedGroup">generateUniqueComputedGroup</a></li><li><a href="global.html#getAllAvailableGroups">getAllAvailableGroups</a></li><li><a href="global.html#getCacheStats">getCacheStats</a></li><li><a href="global.html#getChannelByDisplayName">getChannelByDisplayName</a></li><li><a href="global.html#getChannelMetadata">getChannelMetadata</a></li><li><a href="global.html#getChannelsForFile">getChannelsForFile</a></li><li><a href="global.html#getColorHex">getColorHex</a></li><li><a href="global.html#getCompiledExpression">getCompiledExpression</a></li><li><a href="global.html#getComputedChannelById">getComputedChannelById</a></li><li><a href="global.html#getComputedChannelStorageMetadata">getComputedChannelStorageMetadata</a></li><li><a href="global.html#getComputedChannelsState">getComputedChannelsState</a></li><li><a href="global.html#getElementWidth">getElementWidth</a></li><li><a href="global.html#getFileIndexForTime">getFileIndexForTime</a></li><li><a href="global.html#getOriginalChannelName">getOriginalChannelName</a></li><li><a href="global.html#getSampleIndexInFile">getSampleIndexInFile</a></li><li><a href="global.html#groupChannelsByUnit">groupChannelsByUnit</a></li><li><a href="global.html#handleComputedVerticalLineAddition">handleComputedVerticalLineAddition</a></li><li><a href="global.html#handleVerticalLineAddition">handleVerticalLineAddition</a></li><li><a href="global.html#hasDigitalData">hasDigitalData</a></li><li><a href="global.html#hasStoredComputedChannels">hasStoredComputedChannels</a></li><li><a href="global.html#hideProgress">hideProgress</a></li><li><a href="global.html#hideTooltip">hideTooltip</a></li><li><a href="global.html#importComputedChannelFromJSON">importComputedChannelFromJSON</a></li><li><a href="global.html#initComputedChannelsState">initComputedChannelsState</a></li><li><a href="global.html#initUPlotChart">initUPlotChart</a></li><li><a href="global.html#initializeChartInstance">initializeChartInstance</a></li><li><a href="global.html#initializeComputedChartInstance">initializeComputedChartInstance</a></li><li><a href="global.html#initializeSidebarChannels">initializeSidebarChannels</a></li><li><a href="global.html#injectSidebarIntoUplot">injectSidebarIntoUplot</a></li><li><a href="global.html#isMathJaxLoaded">isMathJaxLoaded</a></li><li><a href="global.html#listenForComputedChannelChanges">listenForComputedChannelChanges</a></li><li><a href="global.html#loadComputedChannelsForGroup">loadComputedChannelsForGroup</a></li><li><a href="global.html#loadComputedChannelsFromStorage">loadComputedChannelsFromStorage</a></li><li><a href="global.html#loadMathJax">loadMathJax</a></li><li><a href="global.html#mathJaxPromise">mathJaxPromise</a></li><li><a href="global.html#measurePerformance">measurePerformance</a></li><li><a href="global.html#mergeAnalogAndComputedMetadata">mergeAnalogAndComputedMetadata</a></li><li><a href="global.html#mergeAnalogChannels">mergeAnalogChannels</a></li><li><a href="global.html#mergeComtradeFilesSetsSequential">mergeComtradeFilesSetsSequential</a></li><li><a href="global.html#mergeDigitalChannels">mergeDigitalChannels</a></li><li><a href="global.html#mergeTimeArraysSequential">mergeTimeArraysSequential</a></li><li><a href="global.html#openAnalysisDrawer">openAnalysisDrawer</a></li><li><a href="global.html#openBothSidebars">openBothSidebars</a></li><li><a href="global.html#openDeltaWindow">openDeltaWindow</a></li><li><a href="global.html#openMathLiveEditor">openMathLiveEditor</a></li><li><a href="global.html#openPhasorDiagram">openPhasorDiagram</a></li><li><a href="global.html#performExport">performExport</a></li><li><a href="global.html#prepareChartDataContext">prepareChartDataContext</a></li><li><a href="global.html#processEquationInput">processEquationInput</a></li><li><a href="global.html#readFileAsText">readFileAsText</a></li><li><a href="global.html#renameChannelWithPrefix">renameChannelWithPrefix</a></li><li><a href="global.html#renderChannelLabelContainer">renderChannelLabelContainer</a></li><li><a href="global.html#renderComputedChannels">renderComputedChannels</a></li><li><a href="global.html#renderLatex">renderLatex</a></li><li><a href="global.html#resizeChartsToContainers">resizeChartsToContainers</a></li><li><a href="global.html#resolveGroupIndices">resolveGroupIndices</a></li><li><a href="global.html#resolveTimeArray">resolveTimeArray</a></li><li><a href="global.html#saveComputedChannelsToStorage">saveComputedChannelsToStorage</a></li><li><a href="global.html#setupMobileSidebar">setupMobileSidebar</a></li><li><a href="global.html#showChannelListWindow">showChannelListWindow</a></li><li><a href="global.html#showError">showError</a></li><li><a href="global.html#showExportFormatDialog">showExportFormatDialog</a></li><li><a href="global.html#showFileInfo">showFileInfo</a></li><li><a href="global.html#showProgress">showProgress</a></li><li><a href="global.html#subscribeChartUpdates">subscribeChartUpdates</a></li><li><a href="global.html#syncComputedChannelsWithParent">syncComputedChannelsWithParent</a></li><li><a href="global.html#themeContext">themeContext</a></li><li><a href="global.html#toggleChartsVisibility">toggleChartsVisibility</a></li><li><a href="global.html#updateComputedChannelGroupInStorage">updateComputedChannelGroupInStorage</a></li><li><a href="global.html#updateComputedChannelsSidebar">updateComputedChannelsSidebar</a></li><li><a href="global.html#updateFileInfo">updateFileInfo</a></li><li><a href="global.html#updateProgress">updateProgress</a></li><li><a href="global.html#updateStatsCards">updateStatsCards</a></li><li><a href="global.html#updateTooltip">updateTooltip</a></li><li><a href="global.html#validateChannelName">validateChannelName</a></li><li><a href="global.html#validateGroupIndices">validateGroupIndices</a></li><li><a href="global.html#wrapChartInSection">wrapChartInSection</a></li></ul></div>
                
            </nav>
        </div>
        <div class="core" id="main-content-wrapper">
            <div class="content">
                <header class="page-title">
                    <p>Source</p>
                    <h1>plugins/digitalFillPlugin.js</h1>
                </header>
                



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * uPlot plugin for rendering filled regions under digital (boolean) signals.
 *
 * This plugin draws filled rectangles under digital signals (step lines) when the signal is in the "high" state (as defined by targetVal).
 * It supports multiple digital signals, each with its own vertical offset, color, and target value.
 *
 * The fill is drawn in sync with zoom/pan and respects the current axis scales.
 *
 *
 * @warning offset is expected to be always even when u.data contains offset. Else, define yData as
 * @param {Array&lt;Object>} signals - Array of signal configuration objects.
 *   Each object should have:
 *     - signalIndex {number}: Index of the signal in the uPlot data array (e.g., 1 for the first signal after x).
 *     - offset {number}: Vertical offset to apply to the signal (for stacking multiple signals).
 *     - color {string}: Fill color for the high region (CSS color, e.g., 'rgba(0,150,255,0.3)').
 *     - targetVal {number}: Value to consider as "high" (usually 1).
 *
 * @returns {Object} uPlot plugin object to be included in the `plugins` array of uPlot options.
 *
 * @example
 * import { createDigitalFillPlugin } from './src/plugins/digitalFillPlugin.js';
 *
 * const xVals = [0, 1, 2, 3, 4, 5, 6];
 * const signal1 = [1, 0, 1, 1, 0, 1, 0];
 * const signal2 = [1, 1, 1, 0, 1, 1, 1];
 *
 * const signals = [
 *   { signalIndex: 1, offset: 0, color: 'rgba(0, 150, 255, 0.3)', targetVal: 1 },
 *   { signalIndex: 2, offset: 3, color: 'rgba(255, 100, 100, 0.3)', targetVal: 1 }
 * ];
 *
 * const opts = {
 *   width: 600,
 *   height: 300,
 *   scales: { x: { time: false }, y: { min: 0, max: 6 } },
 *   axes: [{}, {}],
 *   series: [
 *     {}, // x axis
 *     { label: "Signal 1", stroke: "transparent" },
 *     { label: "Signal 2", stroke: "transparent" }
 *   ],
 *   plugins: [
 *     createDigitalFillPlugin(signals)
 *   ]
 * };
 *
 * const data = [xVals, signal1, signal2];
 * new uPlot(opts, data, document.getElementById("chart-digital"));
 */
export function createDigitalFillPlugin(signals) {
  // signals: [{signalIndex, offset, color, targetVal, originalIndex?}]
  const currentColors = signals.map((s) => s.color);

  // âœ… DEBUG: Log plugin initialization
  console.log("[digitalFillPlugin] ðŸ”§ Plugin initialized", {
    signalsCount: signals.length,
    signals: signals.map((s, i) => ({
      index: i,
      signalIndex: s.signalIndex,
      color: s.color,
      offset: s.offset,
      targetVal: s.targetVal,
      originalIndex: s.originalIndex,
    })),
    currentColors: currentColors,
  });

  const plugin = {
    id: "digitalFill",
    signals,
    getSignalColors() {
      // returns array [{ originalIndex, color }]
      return signals.map((sig, i) => ({
        originalIndex: sig.originalIndex ?? i,
        color: currentColors[i] || sig.color,
      }));
    },
    updateColors(newColors) {
      // âœ… CRITICAL: If newColors is the FULL array (592 colors), map using originalIndex!
      // If newColors is a filtered display array (5 colors), use signal index directly

      const isFullArray = Array.isArray(newColors) &amp;&amp; newColors.length > 100;

      console.log("[digitalFillPlugin] ðŸŽ¯ updateColors called:", {
        receivedLength: Array.isArray(newColors)
          ? newColors.length
          : "not array",
        currentSignals: signals.length,
        isFullArray: isFullArray,
        firstNewColors: Array.isArray(newColors)
          ? newColors.slice(0, 5)
          : "N/A",
      });

      let changed = false;

      // âœ… FIX: Use originalIndex to map from FULL array (592 colors)
      signals.forEach((sig, signalIdx) => {
        let newColor;

        if (isFullArray) {
          // Full array case: use originalIndex to look up the color
          const originalIdx = sig.originalIndex ?? signalIdx;
          newColor = newColors[originalIdx];

          console.log(
            `[digitalFillPlugin] ðŸ” Signal ${signalIdx}: originalIndex=${originalIdx}, accessing newColors[${originalIdx}]`
          );
        } else {
          // Display array case: use signal index directly
          newColor = Array.isArray(newColors)
            ? newColors[signalIdx]
            : newColors?.[signalIdx];
        }

        if (newColor &amp;&amp; newColor !== currentColors[signalIdx]) {
          console.log(
            `[digitalFillPlugin] âœ… Signal ${signalIdx} color UPDATE: "${currentColors[signalIdx]}" â†’ "${newColor}"`
          );
          currentColors[signalIdx] = newColor;
          sig.color = newColor;
          changed = true;
        } else {
          console.log(
            `[digitalFillPlugin] â­ï¸ Signal ${signalIdx}: No change (newColor=${newColor}, current=${currentColors[signalIdx]})`
          );
        }
      });

      console.log("[digitalFillPlugin] ðŸ“Š updateColors result:", {
        changed,
        updatedColors: [...currentColors],
        colorMapping: signals.map((sig, i) => ({
          signalIdx: i,
          originalIdx: sig.originalIndex,
          currentColor: currentColors[i],
        })),
      });

      return changed;
    },
    // Allow external components to query the current colors
    getSignalColors() {
      return signals.map((sig, idx) => ({
        originalIndex: sig.originalIndex,
        color: currentColors[idx] || sig.color,
      }));
    },
    hooks: {
      setScale: [
        (u, scaleKey, opts) => {
          // âœ… DEBUG: Log setScale hook
          console.log("[digitalFillPlugin] setScale hook called", {
            scaleKey,
            opts,
            currentYScale: u?.scales?.y,
          });

          const yScaleOpts = u?.opts?.scales?.y;

          // âœ… FIX: Only force scale if it's NOT already set
          if (!yScaleOpts || yScaleOpts.auto !== false) {
            // Use the provided scale or default to 0-15
            const minVal = yScaleOpts?.min ?? 0;
            const maxVal = yScaleOpts?.max ?? 15;

            console.log("[digitalFillPlugin] Setting y-scale to:", {
              min: minVal,
              max: maxVal,
            });

            u.setScale("y", { min: minVal, max: maxVal, auto: false });
          } else {
            console.log(
              "[digitalFillPlugin] Y-scale already configured:",
              yScaleOpts
            );
          }
        },
      ],
      init: [
        (u) => {
          // âœ… DEBUG: Log when plugin is initialized in uPlot
          console.log("[digitalFillPlugin] âœ… Plugin init hook called", {
            chartWidth: u.width,
            chartHeight: u.height,
            dataLength: u.data?.[0]?.length,
            series: u.series.length,
          });
        },
      ],
      draw: [
        (u) => {
          const { ctx } = u;
          const xData = u.data[0];
          const n = xData.length;
          const yScale = u.scales.y;

          // âœ… DEBUG: Log draw hook execution with full validation
          console.log("[digitalFillPlugin] ðŸŽ¨ Draw hook called", {
            signals: signals.length,
            currentColors: currentColors,
            yScaleMin: yScale?.min,
            yScaleMax: yScale?.max,
            xDataLength: xData?.length,
            dataArrays: u.data.length,
            canvasSize: {
              width: ctx.canvas?.width,
              height: ctx.canvas?.height,
            },
          });

          // âœ… VALIDATION: Check if we have valid data
          if (!xData || xData.length === 0) {
            console.warn(
              "[digitalFillPlugin] âŒ No x-axis data available, skipping draw"
            );
            return;
          }

          if (signals.length === 0) {
            console.warn(
              "[digitalFillPlugin] âŒ No signals configured, skipping draw"
            );
            return;
          }

          // âœ… VALIDATION: Check if all signal indices are valid
          signals.forEach((sig, idx) => {
            if (!u.data[sig.signalIndex]) {
              console.warn(
                `[digitalFillPlugin] âš ï¸ Signal ${idx} signalIndex=${sig.signalIndex} not found (only ${u.data.length} arrays)`
              );
            }
          });

          if (isNaN(yScale.min) || isNaN(yScale.max)) {
            console.warn(
              "[digitalFillPlugin] âŒ yScale min/max invalid:",
              yScale
            );
            return;
          }

          // Get the plotting area boundaries to avoid drawing over axes/labels
          const left = u.bbox.left;
          const top = u.bbox.top;
          const right = u.bbox.left + u.bbox.width;
          const bottom = u.bbox.top + u.bbox.height;

          ctx.save();
          ctx.beginPath();
          ctx.rect(left, top, right - left, bottom - top);
          ctx.clip();
          ctx.closePath();

          signals.forEach((sig, idx) => {
            const yData = u.data[sig.signalIndex];

            // âœ… VALIDATION: Check if yData exists
            if (!yData) {
              console.warn(
                `[digitalFillPlugin] âš ï¸ Signal ${idx} has no data at index ${sig.signalIndex}`
              );
              return;
            }

            ctx.save();
            // Use currentColors array if updated, fallback to signal color
            const fillColor =
              currentColors[idx] || sig.color || "rgba(100, 100, 255, 0.5)";

            // âœ… DEBUG: Log color being used for each signal
            console.log(
              `[digitalFillPlugin] Signal ${idx} drawing with color:`,
              {
                currentColor: currentColors[idx],
                sigColor: sig.color,
                usingColor: fillColor,
                yDataLength: yData.length,
                offset: sig.offset,
                targetVal: sig.targetVal,
              }
            );

            // âœ… DEBUG: Set canvas styles and confirm they're applied
            ctx.fillStyle = fillColor;
            ctx.strokeStyle = "black";
            ctx.lineWidth = 1.5;

            console.log(
              `[digitalFillPlugin] Signal ${idx} canvas styles set:`,
              {
                fillStyle: ctx.fillStyle,
                strokeStyle: ctx.strokeStyle,
                lineWidth: ctx.lineWidth,
              }
            );

            ctx.beginPath();
            let beginFill = false;
            let xWidthCount = 0;
            let xBegin = 0,
              yBegin = 0;
            let rectCount = 0; // âœ… Track how many rects drawn
            let drawOps = []; // âœ… Track all draw operations

            // Calculate the minimum value in yData to determine offsetPresent.
            // If the minimum is even, use it; otherwise, use the next lower even number.
            const offsetCalc = Math.min(...yData);
            const offsetPresent =
              offsetCalc % 2 === 0 ? offsetCalc : offsetCalc - 1;

            // Determine the effective offset to use for drawing
            const effectiveOffset = sig.offset;

            // Initial point for the step plot
            const px0 = u.valToPos(xData[0], "x", true);
            const py = u.valToPos(
              yData[0] - offsetPresent + effectiveOffset,
              "y",
              true
            );
            ctx.moveTo(px0, py);

            // If the first value is high, prepare to begin filling
            if (yData[0] === sig.targetVal + offsetPresent) {
              beginFill = true;
              xBegin = px0;
              yBegin = py;
            }

            // Calculate width and height for fill rectangles
            const xWidth = Math.abs(
              u.valToPos(xData[1], "x", true) - u.valToPos(xData[0], "x", true)
            );
            const yHeight = Math.abs(
              u.valToPos(
                yData[0] + sig.targetVal + effectiveOffset,
                "y",
                true
              ) - u.valToPos(yData[0] + effectiveOffset, "y", true)
            );

            // âœ… CRITICAL DIAGNOSTIC: Log exact drawing parameters
            console.log(
              `[digitalFillPlugin] Signal ${idx} PRE-DRAW DIAGNOSTIC:`,
              {
                fillColor,
                canvasFillStyle: ctx.fillStyle,
                yHeight,
                xWidth,
                firstYData: yData[0],
                targetVal: sig.targetVal,
                offsetPresent,
              }
            );

            // Iterate through all data points to draw step lines and fill regions
            for (let i = 0; i &lt; n - 1; i++) {
              const x0 = u.valToPos(xData[i], "x", true);
              const x1 = u.valToPos(xData[i + 1], "x", true);
              const y = u.valToPos(
                yData[i] - offsetPresent + effectiveOffset,
                "y",
                true
              );
              const y1 = u.valToPos(
                yData[i + 1] - offsetPresent + effectiveOffset,
                "y",
                true
              );

              ctx.lineTo(x1, y);
              if (y !== y1) ctx.lineTo(x1, y1);

              // If the signal transitions from high to low, fill the region
              if (yData[i] != sig.targetVal + offsetPresent) {
                if (beginFill) {
                  // âœ… CRITICAL: Log EXACT fillRect parameters
                  drawOps.push({
                    op: "fillRect",
                    x: xBegin,
                    y: yBegin,
                    width: x0 - xBegin,
                    height: yHeight,
                    color: fillColor,
                  });

                  ctx.fillRect(xBegin, yBegin, x0 - xBegin, yHeight);
                  rectCount++;
                  ctx.stroke();
                }
                beginFill = false;
                xWidthCount = 0;
              }
              // If the signal is high, start or continue filling
              if (yData[i] == sig.targetVal + offsetPresent) {
                if (!beginFill) {
                  beginFill = true;
                  xBegin = x0;
                  yBegin = y;
                }
                xWidthCount++;
                // If this is the last point, fill to the end
                if (i === n - 2) {
                  // âœ… CRITICAL: Log EXACT fillRect parameters
                  drawOps.push({
                    op: "fillRect",
                    x: xBegin,
                    y: yBegin,
                    width: x1 - xBegin,
                    height: yHeight,
                    color: fillColor,
                  });

                  ctx.fillRect(xBegin, yBegin, x1 - xBegin, yHeight);
                  rectCount++;
                  ctx.stroke();
                }
              }
            }
            ctx.stroke();
            ctx.closePath();

            // âœ… CRITICAL DIAGNOSTIC: Log all rectangles drawn
            console.log(`[digitalFillPlugin] Signal ${idx} DRAW OPERATIONS:`, {
              rectanglesDrawn: rectCount,
              operations: drawOps.slice(0, 5), // First 5 ops for brevity
              totalOps: drawOps.length,
              yHeightValid: yHeight > 0,
              fillColorValid: !!fillColor &amp;&amp; fillColor !== "rgba(0,0,0,0)",
            });

            ctx.restore();
          });
          ctx.restore(); // Remove the clip

          // âœ… DEBUG: Confirm draw hook completed
          console.log("[digitalFillPlugin] âœ… Draw hook completed");
        },
      ],
    },
  };
  return plugin;
}
</code></pre>
        </article>
    </section>




            </div>
            
            <footer class="footer">
                <div class="content has-text-centered">
                    <p>Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.5</a></p>
                    <p class="sidebar-created-by">
                        <a href="https://github.com/SoftwareBrothers/better-docs" target="_blank">BetterDocs theme</a> provided with <i class="fas fa-heart"></i> by
                        <a href="http://softwarebrothers.co" target="_blank">SoftwareBrothers - JavaScript Development Agency</a>
                    </p>
                </div>
            </footer>
            
        </div>
        <div id="side-nav" class="side-nav">
        </div>
    </div>
<script src="scripts/app.min.js"></script>
<script>PR.prettyPrint();</script>
<script src="scripts/linenumber.js"> </script>


</body>
</html>
