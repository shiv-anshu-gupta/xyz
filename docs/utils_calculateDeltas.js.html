

<!DOCTYPE html>
<html lang="en">

<head>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title> utils/calculateDeltas.js</title>

  <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- build/entry.js removed - not needed -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,400,700|Inconsolata,700" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
  <link type="text/css" rel="stylesheet" href="https://jmblog.github.io/color-themes-for-google-code-prettify/themes/tomorrow-night.min.css">
  <link type="text/css" rel="stylesheet" href="styles/app.min.css">
  <link type="text/css" rel="stylesheet" href="styles/iframe.css">
  <link type="text/css" rel="stylesheet" href="">
  <script async defer src="https://buttons.github.io/buttons.js"></script>

  
</head>



<body class="layout small-header">
    <div id="stickyNavbarOverlay"></div>
    

<div class="top-nav">
    <div class="inner">
        <a id="hamburger" role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
        </a>
        <div class="logo">
            
            
        </div>
        <div class="menu">
            
            <div class="navigation">
                <a
                    href="index.html"
                    class="link"
                >
                    Documentation
                </a>
                
                
                
            </div>
        </div>
    </div>
</div>
    <div id="main">
        <div
            class="sidebar "
            id="sidebarNav"
        >
            
            <nav>
                
                    <h2><a href="index.html">Documentation</a></h2><div class="category"><h3>Modules</h3><ul><li><a href="module-Context_ThemeContext.html">Context/ThemeContext</a></li><li><a href="module-analyzeGroupsAndPublish.html">analyzeGroupsAndPublish</a></li><li><a href="module-axisBuilder.html">axisBuilder</a></li><li><a href="module-axisCalculator.html">axisCalculator</a></li><li><a href="module-calculateAndPublishMaxYAxes.html">calculateAndPublishMaxYAxes</a></li><li><a href="module-chartAxisAlignment.html">chartAxisAlignment</a></li><li><a href="module-chartComponent.html">chartComponent</a></li><li><a href="module-chartManager.html">chartManager</a></li><li><a href="module-chartUpdateHelpers.html">chartUpdateHelpers</a></li><li><a href="module-components_AnalysisSidebar.html">components/AnalysisSidebar</a></li><li><a href="module-components_ChannelList.html">components/ChannelList</a></li><li><a href="module-components_ComputedChannelsSidebar.html">components/ComputedChannelsSidebar</a></li><li><a href="module-components_DeltaDrawer.html">components/DeltaDrawer</a></li><li><a href="module-components_DeltaTable.html">components/DeltaTable</a></li><li><a href="module-components_DeltaTableDataFormatter.html">components/DeltaTableDataFormatter</a></li><li><a href="module-components_DeltaTableRenderer.html">components/DeltaTableRenderer</a></li><li><a href="module-components_EquationEvaluatorInChannelList.html">components/EquationEvaluatorInChannelList</a></li><li><a href="module-components_PolarChart.html">components/PolarChart</a></li><li><a href="module-components_PolarChartCanvas.html">components/PolarChartCanvas</a></li><li><a href="module-components_ProgressBar.html">components/ProgressBar</a></li><li><a href="module-components_ResizableGroup.html">components/ResizableGroup</a></li><li><a href="module-components_SidebarResizer.html">components/SidebarResizer</a></li><li><a href="module-components_Tooltip.html">components/Tooltip</a></li><li><a href="module-components_debugPanelLite.html">components/debugPanelLite</a></li><li><a href="module-components_renderComputedChart.html">components/renderComputedChart</a></li><li><a href="module-components_renderComtradeCharts.html">components/renderComtradeCharts</a></li><li><a href="module-components_renderDigitalCharts.html">components/renderDigitalCharts</a></li><li><a href="module-components_renderSingleAnalogChart.html">components/renderSingleAnalogChart</a></li><li><a href="module-components_renderSingleDigitalChart.html">components/renderSingleDigitalChart</a></li><li><a href="module-components_setupPolarChartIntegration.html">components/setupPolarChartIntegration</a></li><li><a href="module-components_showError.html">components/showError</a></li><li><a href="module-components_verticalLineControl.html">components/verticalLineControl</a></li><li><a href="module-comtradeUtils.html">comtradeUtils</a></li><li><a href="module-createDragBar.html">createDragBar</a></li><li><a href="module-createState.html">createState</a></li><li><a href="module-domUpdateQueue.html">domUpdateQueue</a></li><li><a href="module-domUpdateQueueInit.html">domUpdateQueueInit</a></li><li><a href="module-eventListenerManager.html">eventListenerManager</a></li><li><a href="module-handleVerticalLineShortcuts.html">handleVerticalLineShortcuts</a></li><li><a href="module-initVerticalLineControl.html">initVerticalLineControl</a></li><li><a href="module-main.html">main</a></li><li><a href="module-maxYAxesStore.html">maxYAxesStore</a></li><li><a href="module-mergerWindowLauncher.html">mergerWindowLauncher</a></li><li><a href="module-plugins_autoUnitScalePlugin.html">plugins/autoUnitScalePlugin</a></li><li><a href="module-plugins_axisLinesPlugin.html">plugins/axisLinesPlugin</a></li><li><a href="module-plugins_deltaBoxPlugin.html">plugins/deltaBoxPlugin</a></li><li><a href="module-plugins_horizontalZoomPanPlugin.html">plugins/horizontalZoomPanPlugin</a></li><li><a href="module-plugins_verticalLinePlugin.html">plugins/verticalLinePlugin</a></li><li><a href="module-seriesMapper.html">seriesMapper</a></li><li><a href="module-services_computedChannels.html">services/computedChannels</a></li><li><a href="module-services_computedChannels_dataPreparation.html">services/computedChannels/dataPreparation</a></li><li><a href="module-services_computedChannels_eventHandling.html">services/computedChannels/eventHandling</a></li><li><a href="module-services_computedChannels_expressionConversion.html">services/computedChannels/expressionConversion</a></li><li><a href="module-services_computedChannels_resultProcessing.html">services/computedChannels/resultProcessing</a></li><li><a href="module-services_computedChannels_stateUpdate.html">services/computedChannels/stateUpdate</a></li><li><a href="module-services_computedChannels_validators.html">services/computedChannels/validators</a></li><li><a href="module-services_computedChannels_workerManagement.html">services/computedChannels/workerManagement</a></li><li><a href="module-setupChartDragAndDrop.html">setupChartDragAndDrop</a></li><li><a href="module-timeInterpolation.html">timeInterpolation</a></li><li><a href="module-utils_autoGroupChannels.html">utils/autoGroupChannels</a></li><li><a href="module-utils_chartDomUtils.html">utils/chartDomUtils</a></li><li><a href="module-utils_chartMetadataStore.html">utils/chartMetadataStore</a></li><li><a href="module-utils_computedChannelMetadata.html">utils/computedChannelMetadata</a></li><li><a href="module-utils_constants.html">utils/constants</a></li><li><a href="module-utils_helpers.html">utils/helpers</a></li><li><a href="module-utils_sidebarStore.html">utils/sidebarStore</a></li><li><a href="module-workers_computedChannelWorker.html">workers/computedChannelWorker</a></li></ul><h3>Classes</h3><ul><li><a href="module-components_PolarChartCanvas.PolarChartCanvas.html">PolarChartCanvas</a></li><li><a href="module-utils_computedChannelMetadata-ComputedChannelMetadata.html">ComputedChannelMetadata</a></li></ul><h3>Global</h3><ul><li><a href="global.html#IMPLEMENTATION_COMPLETE">IMPLEMENTATION_COMPLETE</a></li><li><a href="global.html#QUICK_REFERENCE">QUICK_REFERENCE</a></li><li><a href="global.html#STORAGE_CFG_KEY">STORAGE_CFG_KEY</a></li><li><a href="global.html#ZOOM_ICONS">ZOOM_ICONS</a></li><li><a href="global.html#adjustMainContent">adjustMainContent</a></li><li><a href="global.html#appendComputedChannelToStorage">appendComputedChannelToStorage</a></li><li><a href="global.html#applyZoom">applyZoom</a></li><li><a href="global.html#attachChartContainer">attachChartContainer</a></li><li><a href="global.html#attachChartEventHandlers">attachChartEventHandlers</a></li><li><a href="global.html#attachChartPlugins">attachChartPlugins</a></li><li><a href="global.html#attachComputedChartContainer">attachComputedChartContainer</a></li><li><a href="global.html#attachComputedChartEventHandlers">attachComputedChartEventHandlers</a></li><li><a href="global.html#attachComputedChartPlugins">attachComputedChartPlugins</a></li><li><a href="global.html#broadcastComputedChannelChange">broadcastComputedChannelChange</a></li><li><a href="global.html#buildChartData">buildChartData</a></li><li><a href="global.html#buildChartOptions">buildChartOptions</a></li><li><a href="global.html#buildComputedChannelLabels">buildComputedChannelLabels</a></li><li><a href="global.html#buildComputedChartOptions">buildComputedChartOptions</a></li><li><a href="global.html#buildGroupsWithAutoGrouping">buildGroupsWithAutoGrouping</a></li><li><a href="global.html#buildGroupsWithUserAssignments">buildGroupsWithUserAssignments</a></li><li><a href="global.html#buildUnitChartData">buildUnitChartData</a></li><li><a href="global.html#calculateStats">calculateStats</a></li><li><a href="global.html#chart2">chart2</a></li><li><a href="global.html#cleanupOldComputedCharts">cleanupOldComputedCharts</a></li><li><a href="global.html#clearChartsContainer">clearChartsContainer</a></li><li><a href="global.html#clearComputedChannelsFromStorage">clearComputedChannelsFromStorage</a></li><li><a href="global.html#clearExpressionCache">clearExpressionCache</a></li><li><a href="global.html#closeAnalysisDrawer">closeAnalysisDrawer</a></li><li><a href="global.html#collectChartDeltas">collectChartDeltas</a></li><li><a href="global.html#computeChartDataDimensions">computeChartDataDimensions</a></li><li><a href="global.html#createBinaryBlob">createBinaryBlob</a></li><li><a href="global.html#createChannelList">createChannelList</a></li><li><a href="global.html#createChartMetadata">createChartMetadata</a></li><li><a href="global.html#createChartOptions">createChartOptions</a></li><li><a href="global.html#createComputedChartMetadata">createComputedChartMetadata</a></li><li><a href="global.html#createComputedClickHandler">createComputedClickHandler</a></li><li><a href="global.html#createComputedMousemoveHandler">createComputedMousemoveHandler</a></li><li><a href="global.html#createDigitalFillPlugin">createDigitalFillPlugin</a></li><li><a href="global.html#createGroupDragBar">createGroupDragBar</a></li><li><a href="global.html#createMousemoveHandler">createMousemoveHandler</a></li><li><a href="global.html#createScopeTemplate">createScopeTemplate</a></li><li><a href="global.html#createState">createState</a></li><li><a href="global.html#createVerticalLineClickHandler">createVerticalLineClickHandler</a></li><li><a href="global.html#createZoomControlsHTML">createZoomControlsHTML</a></li><li><a href="global.html#debounce">debounce</a></li><li><a href="global.html#deleteComputedChannelFromStorage">deleteComputedChannelFromStorage</a></li><li><a href="global.html#encodeFloat64">encodeFloat64</a></li><li><a href="global.html#encodeInt32">encodeInt32</a></li><li><a href="global.html#evaluateExpression">evaluateExpression</a></li><li><a href="global.html#exportAllChannelsAsCSV">exportAllChannelsAsCSV</a></li><li><a href="global.html#exportComputedChannelsAsCSV">exportComputedChannelsAsCSV</a></li><li><a href="global.html#extractChannelMetadata">extractChannelMetadata</a></li><li><a href="global.html#extractChannelNameFromEquation">extractChannelNameFromEquation</a></li><li><a href="global.html#extractGroupId">extractGroupId</a></li><li><a href="global.html#extractMathExpression">extractMathExpression</a></li><li><a href="global.html#filterGroupsWithChannels">filterGroupsWithChannels</a></li><li><a href="global.html#filterUnassignedComputedChannels">filterUnassignedComputedChannels</a></li><li><a href="global.html#filterValidIndices">filterValidIndices</a></li><li><a href="global.html#formatEquationForLatex">formatEquationForLatex</a></li><li><a href="global.html#formatScaledValue">formatScaledValue</a></li><li><a href="global.html#generateCFGContentBinary32">generateCFGContentBinary32</a></li><li><a href="global.html#generateCFGContentBinary64">generateCFGContentBinary64</a></li><li><a href="global.html#generateCFGContentFloat32">generateCFGContentFloat32</a></li><li><a href="global.html#generateCFGContentFloat64">generateCFGContentFloat64</a></li><li><a href="global.html#generateDATContentBinary32">generateDATContentBinary32</a></li><li><a href="global.html#generateDATContentBinary64">generateDATContentBinary64</a></li><li><a href="global.html#generateDATContentFloat32">generateDATContentFloat32</a></li><li><a href="global.html#generateDATContentFloat64">generateDATContentFloat64</a></li><li><a href="global.html#getCacheStats">getCacheStats</a></li><li><a href="global.html#getChannelByDisplayName">getChannelByDisplayName</a></li><li><a href="global.html#getChannelMetadata">getChannelMetadata</a></li><li><a href="global.html#getChannelsForFile">getChannelsForFile</a></li><li><a href="global.html#getCompiledExpression">getCompiledExpression</a></li><li><a href="global.html#getComputedChannelById">getComputedChannelById</a></li><li><a href="global.html#getComputedChannelStorageMetadata">getComputedChannelStorageMetadata</a></li><li><a href="global.html#getComputedChannelsState">getComputedChannelsState</a></li><li><a href="global.html#getElementWidth">getElementWidth</a></li><li><a href="global.html#getFileIndexForTime">getFileIndexForTime</a></li><li><a href="global.html#getOriginalChannelName">getOriginalChannelName</a></li><li><a href="global.html#getSampleIndexInFile">getSampleIndexInFile</a></li><li><a href="global.html#getZoomLevel">getZoomLevel</a></li><li><a href="global.html#groupChannelsByUnit">groupChannelsByUnit</a></li><li><a href="global.html#handleComputedVerticalLineAddition">handleComputedVerticalLineAddition</a></li><li><a href="global.html#handleVerticalLineAddition">handleVerticalLineAddition</a></li><li><a href="global.html#hasStoredComputedChannels">hasStoredComputedChannels</a></li><li><a href="global.html#initComputedChannelsState">initComputedChannelsState</a></li><li><a href="global.html#initializeChartInstance">initializeChartInstance</a></li><li><a href="global.html#initializeComputedChartInstance">initializeComputedChartInstance</a></li><li><a href="global.html#initializeSidebarChannels">initializeSidebarChannels</a></li><li><a href="global.html#initializeZoomControls">initializeZoomControls</a></li><li><a href="global.html#injectZoomControls">injectZoomControls</a></li><li><a href="global.html#isMathJaxLoaded">isMathJaxLoaded</a></li><li><a href="global.html#listenForComputedChannelChanges">listenForComputedChannelChanges</a></li><li><a href="global.html#loadComputedChannelsForGroup">loadComputedChannelsForGroup</a></li><li><a href="global.html#loadComputedChannelsFromStorage">loadComputedChannelsFromStorage</a></li><li><a href="global.html#loadMathJax">loadMathJax</a></li><li><a href="global.html#mathJaxPromise">mathJaxPromise</a></li><li><a href="global.html#measurePerformance">measurePerformance</a></li><li><a href="global.html#mergeAnalogAndComputedMetadata">mergeAnalogAndComputedMetadata</a></li><li><a href="global.html#mergeAnalogChannels">mergeAnalogChannels</a></li><li><a href="global.html#mergeComtradeFilesSetsSequential">mergeComtradeFilesSetsSequential</a></li><li><a href="global.html#mergeDigitalChannels">mergeDigitalChannels</a></li><li><a href="global.html#mergeTimeArraysSequential">mergeTimeArraysSequential</a></li><li><a href="global.html#openAnalysisDrawer">openAnalysisDrawer</a></li><li><a href="global.html#openBothSidebars">openBothSidebars</a></li><li><a href="global.html#openDeltaWindow">openDeltaWindow</a></li><li><a href="global.html#openPhasorDiagram">openPhasorDiagram</a></li><li><a href="global.html#prepareChartDataContext">prepareChartDataContext</a></li><li><a href="global.html#processEquationInput">processEquationInput</a></li><li><a href="global.html#renameChannelWithPrefix">renameChannelWithPrefix</a></li><li><a href="global.html#renderChannelLabelContainer">renderChannelLabelContainer</a></li><li><a href="global.html#renderComputedChannels">renderComputedChannels</a></li><li><a href="global.html#renderLatex">renderLatex</a></li><li><a href="global.html#resetZoom">resetZoom</a></li><li><a href="global.html#resizeChartsToContainers">resizeChartsToContainers</a></li><li><a href="global.html#resolveGroupIndices">resolveGroupIndices</a></li><li><a href="global.html#resolveTimeArray">resolveTimeArray</a></li><li><a href="global.html#saveComputedChannelsToStorage">saveComputedChannelsToStorage</a></li><li><a href="global.html#setZoomLevel">setZoomLevel</a></li><li><a href="global.html#setupMobileSidebar">setupMobileSidebar</a></li><li><a href="global.html#showChannelListWindow">showChannelListWindow</a></li><li><a href="global.html#showFileInfo">showFileInfo</a></li><li><a href="global.html#subscribeChartUpdates">subscribeChartUpdates</a></li><li><a href="global.html#syncComputedChannelsWithParent">syncComputedChannelsWithParent</a></li><li><a href="global.html#toggleChartsVisibility">toggleChartsVisibility</a></li><li><a href="global.html#updateComputedChannelGroupInStorage">updateComputedChannelGroupInStorage</a></li><li><a href="global.html#updateComputedChannelInStorage">updateComputedChannelInStorage</a></li><li><a href="global.html#updateFileInfo">updateFileInfo</a></li><li><a href="global.html#updateMainZoomPosition">updateMainZoomPosition</a></li><li><a href="global.html#updateStatsCards">updateStatsCards</a></li><li><a href="global.html#updateZoomDisplay">updateZoomDisplay</a></li><li><a href="global.html#validateChannelName">validateChannelName</a></li><li><a href="global.html#validateGroupIndices">validateGroupIndices</a></li><li><a href="global.html#wrapChartInSection">wrapChartInSection</a></li><li><a href="global.html#zoomIn">zoomIn</a></li><li><a href="global.html#zoomOut">zoomOut</a></li></ul></div>
                
            </nav>
        </div>
        <div class="core" id="main-content-wrapper">
            <div class="content">
                <header class="page-title">
                    <p>Source</p>
                    <h1>utils/calculateDeltas.js</h1>
                </header>
                



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*
 * Calculates ΔX and ΔY between consecutive vertical lines.
 * Accepts timeUnit for correct deltaX labeling.
 *
 * @param {number[]} verticalLinesX - X positions of vertical lines.
 * @param {uPlot} chart - Chart instance containing data.
 * @param {string} [timeUnit] - Time unit for ΔX label.
 */
import { crosshairColors } from "./constants.js";
import { getNearestIndex, createCustomElement } from "./helpers.js";

/**
 * Apply unit scaling and format value with SI prefix
 * @param {number} value - Raw value from data
 * @param {number} scaleFactor - Scale factor from axesScales (e.g., 0.001)
 * @param {string} unit - Unit string (e.g., "A", "V", "W")
 * @returns {string} Formatted value with SI prefix (e.g., "1.91 kA")
 */
function formatScaledValue(value, scaleFactor = 1, unit = "") {
  // Apply scale factor (e.g., 0.001 converts mA → A)
  const scaled = value * scaleFactor;

  // Determine SI prefix based on magnitude
  const absScaled = Math.abs(scaled);
  let siPrefix = "";
  let divisor = 1;

  if (absScaled >= 1e9) {
    siPrefix = "G";
    divisor = 1e9;
  } else if (absScaled >= 1e6) {
    siPrefix = "M";
    divisor = 1e6;
  } else if (absScaled >= 1e3) {
    siPrefix = "k";
    divisor = 1e3;
  } else if (absScaled >= 1) {
    siPrefix = "";
    divisor = 1;
  } else if (absScaled >= 1e-3) {
    siPrefix = "m";
    divisor = 1e-3;
  } else if (absScaled >= 1e-6) {
    siPrefix = "μ";
    divisor = 1e-6;
  } else if (absScaled >= 1e-9) {
    siPrefix = "n";
    divisor = 1e-9;
  }

  const finalValue = scaled / divisor;

  // Format with 2 decimal places - add space between number and unit
  const formatted = `${finalValue.toFixed(2)} ${siPrefix}${unit}`;

  // Debug logging
  console.log(
    `[formatScaledValue] value=${value}, scaleFactor=${scaleFactor}, scaled=${scaled}, absScaled=${absScaled}, siPrefix='${siPrefix}', divisor=${divisor}, result='${formatted}'`
  );

  return formatted;
}

/**
 * Collect delta data from a single chart (without updating UI)
 * @param {number[]} verticalLinesX - X positions of vertical lines
 * @param {uPlot} chart - Chart instance
 * @param {string} timeUnit - Time unit for labels
 * @returns {Object[]} Array of delta data sections
 */
export function collectChartDeltas(
  verticalLinesX,
  chart,
  timeUnit = "microseconds"
) {
  const deltaData = [];

  // Defensive: Check if we have valid data
  if (!Array.isArray(verticalLinesX) || verticalLinesX.length &lt; 1) {
    return deltaData;
  }
  if (!chart || !chart.data || !Array.isArray(chart.data[0])) {
    return deltaData;
  }

  const timeArr = chart.data[0]; // X-axis data
  const seriesData = chart.data.slice(1); // All Y-series data

  if (!Array.isArray(seriesData) || seriesData.length === 0) {
    return deltaData;
  }

  // Get scale factors and units from chart configuration
  const axesScales = chart._axesScales || [];
  const yUnits = chart._yUnits || [];

  // Handle single line: show position values
  if (verticalLinesX.length === 1) {
    const idx = getNearestIndex(timeArr, verticalLinesX[0]);
    if (idx === -1) return deltaData;

    const section = {
      deltaTime: `Line 1: ${timeArr[idx].toFixed(2)}`,
      series: [],
    };

    chart.series.slice(1).forEach((series, j) => {
      if (!seriesData[j] || !Array.isArray(seriesData[j])) return;

      const value = seriesData[j][idx];
      if (typeof value !== "number") return;

      const seriesColor = chart._seriesColors
        ? chart._seriesColors[j]
        : series.stroke || "black";

      // Apply scaling for display
      const scaleFactor = axesScales[j + 1] || 1;
      const channelUnit = yUnits[j] || "";
      const formattedValue = formatScaledValue(value, scaleFactor, channelUnit);

      section.series.push({
        name: series.label || `Series ${j + 1}`,
        color: seriesColor,
        v1: value,
        v2: value,
        deltaY: 0,
        percentage: 0,
        v1Formatted: formattedValue,
        v2Formatted: formattedValue,
        deltaFormatted: `0.00 ${channelUnit}`,
        unit: channelUnit,
      });
    });

    deltaData.push(section);
    return deltaData;
  }

  // Handle multiple lines: show deltas between consecutive pairs
  for (let i = 0; i &lt; verticalLinesX.length - 1; i++) {
    const idx1 = getNearestIndex(timeArr, verticalLinesX[i]);
    const idx2 = getNearestIndex(timeArr, verticalLinesX[i + 1]);

    if (idx1 === -1 || idx2 === -1) continue; // Guard: skip if indices invalid

    const deltaX = (timeArr[idx2] - timeArr[idx1]).toFixed(2);

    // Create delta data section
    const deltaTimeStr = `${deltaX}${
      timeUnit === "seconds"
        ? " s"
        : timeUnit === "milliseconds"
        ? " ms"
        : " μs"
    }`;
    const section = {
      deltaTime: deltaTimeStr,
      series: [],
    };

    // Loop through each data series (skip index 0 because it's x-axis)
    // chart.series[0] is typically the x-axis, so we start from index 1
    chart.series.slice(1).forEach((series, j) => {
      // seriesData[j] corresponds to chart.series[j+1] because chart.data[0] is time
      if (!seriesData[j] || !Array.isArray(seriesData[j])) {
        console.log(
          `[collectChartDeltas] Skipping series ${j} (${
            series.label || "unknown"
          }): data missing or not array`,
          {
            hasData: !!seriesData[j],
            isArray: Array.isArray(seriesData[j]),
          }
        );
        return; // Guard: skip if data missing
      }

      const v1 = seriesData[j][idx1];
      const v2 = seriesData[j][idx2];

      if (typeof v1 !== "number" || typeof v2 !== "number") {
        // This is expected for some digital channels or missing data points
        console.log(
          `[collectChartDeltas] Skipping series ${j} (${
            series.label || "unknown"
          }): values not numeric`,
          {
            v1Type: typeof v1,
            v2Type: typeof v2,
            v1: v1,
            v2: v2,
            idx1,
            idx2,
          }
        );
        return; // Guard: skip if not numbers
      }

      const deltaY = v2 - v1;
      const percentage =
        v1 !== 0 ? ((deltaY / Math.abs(v1)) * 100).toFixed(1) : 0;

      const seriesLabel = series.label || `Series ${j + 1}`;

      // Fetch color from stored metadata or series stroke
      const seriesColor = chart._seriesColors
        ? chart._seriesColors[j]
        : series.stroke || "black";

      // Apply scaling for display
      const scaleFactor = axesScales[j + 1] || 1;
      const channelUnit = yUnits[j] || "";

      const v1Formatted = formatScaledValue(v1, scaleFactor, channelUnit);
      const v2Formatted = formatScaledValue(v2, scaleFactor, channelUnit);
      const deltaFormatted = formatScaledValue(
        deltaY,
        scaleFactor,
        channelUnit
      );

      // Add to delta data
      section.series.push({
        name: seriesLabel,
        color: seriesColor,
        v1, // Keep raw values for calculations
        v2,
        deltaY,
        percentage,
        v1Formatted, // Add formatted values for display
        v2Formatted,
        deltaFormatted,
        unit: channelUnit,
      });
    });

    deltaData.push(section);
  }

  console.log(
    `[collectChartDeltas] Returning ${
      deltaData.length
    } delta sections with ${deltaData.reduce(
      (s, d) => s + (d.series ? d.series.length : 0),
      0
    )} total series`
  );
  return deltaData;
}

export async function calculateDeltas(
  verticalLinesX,
  chart,
  timeUnit = "microseconds"
) {
  const output = document.getElementById("fixed-results");
  if (!output) return; // Guard: exit if output element doesn't exist

  output.innerHTML = "";

  // Defensive: Check if we have valid data
  if (!Array.isArray(verticalLinesX) || verticalLinesX.length &lt; 1) return;
  if (!chart || !chart.data || !Array.isArray(chart.data[0])) return;

  const timeArr = chart.data[0]; // X-axis data
  const seriesData = chart.data.slice(1); // All Y-series data

  if (!Array.isArray(seriesData) || seriesData.length === 0) return;

  // Format data for delta window
  const deltaData = [];

  // Calculate deltas between consecutive vertical lines
  for (let i = 0; i &lt; verticalLinesX.length - 1; i++) {
    const idx1 = getNearestIndex(timeArr, verticalLinesX[i]);
    const idx2 = getNearestIndex(timeArr, verticalLinesX[i + 1]);

    if (idx1 === -1 || idx2 === -1) continue; // Guard: skip if indices invalid

    const deltaX = (timeArr[idx2] - timeArr[idx1]).toFixed(2);

    const border = createCustomElement("div", "border-bottom");
    output.appendChild(border);

    // Create delta data section
    const deltaTimeStr = `${deltaX}${
      timeUnit === "seconds"
        ? " s"
        : timeUnit === "milliseconds"
        ? " ms"
        : " μs"
    }`;
    const section = {
      deltaTime: deltaTimeStr,
      series: [],
    };

    // Loop through each data series (skip index 0 because it's x-axis)
    // chart.series[0] is typically the x-axis, so we start from index 1
    chart.series.slice(1).forEach((series, j) => {
      // seriesData[j] corresponds to chart.series[j+1] because chart.data[0] is time
      if (!seriesData[j] || !Array.isArray(seriesData[j])) {
        console.warn(
          `[calculateDeltas] Series ${j} data missing or not array`,
          {
            seriesLabel: series.label,
            hasData: !!seriesData[j],
            isArray: Array.isArray(seriesData[j]),
          }
        );
        return; // Guard: skip if data missing
      }

      const v1 = seriesData[j][idx1];
      const v2 = seriesData[j][idx2];

      if (typeof v1 !== "number" || typeof v2 !== "number") {
        // This is expected for some digital channels or missing data points
        return; // Guard: skip if not numbers
      }

      const deltaY = v2 - v1;
      const percentage =
        v1 !== 0 ? ((deltaY / Math.abs(v1)) * 100).toFixed(1) : 0;

      const result = createCustomElement("div");

      const seriesLabel = series.label || `Series ${j + 1}`;

      // Fetch color from stored metadata or series stroke
      const seriesColor = chart._seriesColors
        ? chart._seriesColors[j]
        : series.stroke || "black";

      const crosshairColor1 = crosshairColors[i % crosshairColors.length];
      const crosshairColor2 = crosshairColors[(i + 1) % crosshairColors.length];

      let deltaXLabel = `Δtime: ${deltaX}`;
      if (timeUnit === "seconds") deltaXLabel += " s";
      else if (timeUnit === "milliseconds") deltaXLabel += " ms";
      else deltaXLabel += " μs";

      result.innerHTML = `
        &lt;span style="color:${seriesColor}">
          ${seriesLabel}
        &lt;/span> 
        &lt;span style="color:${crosshairColor1}">
          ${deltaXLabel},
        &lt;/span>
        &lt;span style="color:${crosshairColor2}">
          ΔY: ${deltaY.toFixed(2)}
        &lt;/span>
      `;
      output.appendChild(result);

      // Add to delta data
      section.series.push({
        name: seriesLabel,
        color: seriesColor,
        v1,
        v2,
        deltaY,
        percentage,
      });
    });

    deltaData.push(section);
  }

  // Update delta drawer if available
  // Show drawer whenever there are vertical lines (even if just 1)
  try {
    const { deltaWindow } = await import("../main.js");
    if (deltaWindow &amp;&amp; verticalLinesX.length > 0) {
      deltaWindow.show(); // Open the drawer
      deltaWindow.update(deltaData, verticalLinesX.length);
    }
  } catch (e) {
    // Delta window not available yet, that's okay
  }
}
</code></pre>
        </article>
    </section>




            </div>
            
            <footer class="footer">
                <div class="content has-text-centered">
                    <p>Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.5</a></p>
                    <p class="sidebar-created-by">
                        <a href="https://github.com/SoftwareBrothers/better-docs" target="_blank">BetterDocs theme</a> provided with <i class="fas fa-heart"></i> by
                        <a href="http://softwarebrothers.co" target="_blank">SoftwareBrothers - JavaScript Development Agency</a>
                    </p>
                </div>
            </footer>
            
        </div>
        <div id="side-nav" class="side-nav">
        </div>
    </div>
<script src="scripts/app.min.js"></script>
<script>PR.prettyPrint();</script>
<script src="scripts/linenumber.js"> </script>


</body>
</html>
