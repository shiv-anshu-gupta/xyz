

<!DOCTYPE html>
<html lang="en">

<head>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title> services/computedChannels/resultProcessing.js</title>

  <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- build/entry.js removed - not needed -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,400,700|Inconsolata,700" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
  <link type="text/css" rel="stylesheet" href="https://jmblog.github.io/color-themes-for-google-code-prettify/themes/tomorrow-night.min.css">
  <link type="text/css" rel="stylesheet" href="styles/app.min.css">
  <link type="text/css" rel="stylesheet" href="styles/iframe.css">
  <link type="text/css" rel="stylesheet" href="">
  <script async defer src="https://buttons.github.io/buttons.js"></script>

  
</head>



<body class="layout small-header">
    <div id="stickyNavbarOverlay"></div>
    

<div class="top-nav">
    <div class="inner">
        <a id="hamburger" role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
        </a>
        <div class="logo">
            
            
        </div>
        <div class="menu">
            
            <div class="navigation">
                <a
                    href="index.html"
                    class="link"
                >
                    Documentation
                </a>
                
                
                
            </div>
        </div>
    </div>
</div>
    <div id="main">
        <div
            class="sidebar "
            id="sidebarNav"
        >
            
            <nav>
                
                    <h2><a href="index.html">Documentation</a></h2><div class="category"><h3>Modules</h3><ul><li><a href="module-Context_ThemeContext.html">Context/ThemeContext</a></li><li><a href="module-analyzeGroupsAndPublish.html">analyzeGroupsAndPublish</a></li><li><a href="module-axisBuilder.html">axisBuilder</a></li><li><a href="module-axisCalculator.html">axisCalculator</a></li><li><a href="module-calculateAndPublishMaxYAxes.html">calculateAndPublishMaxYAxes</a></li><li><a href="module-chartAxisAlignment.html">chartAxisAlignment</a></li><li><a href="module-chartComponent.html">chartComponent</a></li><li><a href="module-chartManager.html">chartManager</a></li><li><a href="module-chartUpdateHelpers.html">chartUpdateHelpers</a></li><li><a href="module-components_AnalysisSidebar.html">components/AnalysisSidebar</a></li><li><a href="module-components_ChannelList.html">components/ChannelList</a></li><li><a href="module-components_ComputedChannelsSidebar.html">components/ComputedChannelsSidebar</a></li><li><a href="module-components_DeltaDrawer.html">components/DeltaDrawer</a></li><li><a href="module-components_DeltaTable.html">components/DeltaTable</a></li><li><a href="module-components_DeltaTableDataFormatter.html">components/DeltaTableDataFormatter</a></li><li><a href="module-components_DeltaTableRenderer.html">components/DeltaTableRenderer</a></li><li><a href="module-components_EquationEvaluatorInChannelList.html">components/EquationEvaluatorInChannelList</a></li><li><a href="module-components_PolarChart.html">components/PolarChart</a></li><li><a href="module-components_PolarChartCanvas.html">components/PolarChartCanvas</a></li><li><a href="module-components_ProgressBar.html">components/ProgressBar</a></li><li><a href="module-components_ResizableGroup.html">components/ResizableGroup</a></li><li><a href="module-components_SidebarResizer.html">components/SidebarResizer</a></li><li><a href="module-components_Tooltip.html">components/Tooltip</a></li><li><a href="module-components_debugPanelLite.html">components/debugPanelLite</a></li><li><a href="module-components_renderComputedChart.html">components/renderComputedChart</a></li><li><a href="module-components_renderComtradeCharts.html">components/renderComtradeCharts</a></li><li><a href="module-components_renderDigitalCharts.html">components/renderDigitalCharts</a></li><li><a href="module-components_renderSingleAnalogChart.html">components/renderSingleAnalogChart</a></li><li><a href="module-components_renderSingleDigitalChart.html">components/renderSingleDigitalChart</a></li><li><a href="module-components_setupPolarChartIntegration.html">components/setupPolarChartIntegration</a></li><li><a href="module-components_showError.html">components/showError</a></li><li><a href="module-components_verticalLineControl.html">components/verticalLineControl</a></li><li><a href="module-comtradeUtils.html">comtradeUtils</a></li><li><a href="module-createDragBar.html">createDragBar</a></li><li><a href="module-createState.html">createState</a></li><li><a href="module-domUpdateQueue.html">domUpdateQueue</a></li><li><a href="module-domUpdateQueueInit.html">domUpdateQueueInit</a></li><li><a href="module-eventListenerManager.html">eventListenerManager</a></li><li><a href="module-handleVerticalLineShortcuts.html">handleVerticalLineShortcuts</a></li><li><a href="module-initVerticalLineControl.html">initVerticalLineControl</a></li><li><a href="module-main.html">main</a></li><li><a href="module-maxYAxesStore.html">maxYAxesStore</a></li><li><a href="module-mergerWindowLauncher.html">mergerWindowLauncher</a></li><li><a href="module-plugins_autoUnitScalePlugin.html">plugins/autoUnitScalePlugin</a></li><li><a href="module-plugins_axisLinesPlugin.html">plugins/axisLinesPlugin</a></li><li><a href="module-plugins_deltaBoxPlugin.html">plugins/deltaBoxPlugin</a></li><li><a href="module-plugins_horizontalZoomPanPlugin.html">plugins/horizontalZoomPanPlugin</a></li><li><a href="module-plugins_verticalLinePlugin.html">plugins/verticalLinePlugin</a></li><li><a href="module-seriesMapper.html">seriesMapper</a></li><li><a href="module-services_computedChannels.html">services/computedChannels</a></li><li><a href="module-services_computedChannels_dataPreparation.html">services/computedChannels/dataPreparation</a></li><li><a href="module-services_computedChannels_eventHandling.html">services/computedChannels/eventHandling</a></li><li><a href="module-services_computedChannels_expressionConversion.html">services/computedChannels/expressionConversion</a></li><li><a href="module-services_computedChannels_resultProcessing.html">services/computedChannels/resultProcessing</a></li><li><a href="module-services_computedChannels_stateUpdate.html">services/computedChannels/stateUpdate</a></li><li><a href="module-services_computedChannels_validators.html">services/computedChannels/validators</a></li><li><a href="module-services_computedChannels_workerManagement.html">services/computedChannels/workerManagement</a></li><li><a href="module-setupChartDragAndDrop.html">setupChartDragAndDrop</a></li><li><a href="module-timeInterpolation.html">timeInterpolation</a></li><li><a href="module-utils_autoGroupChannels.html">utils/autoGroupChannels</a></li><li><a href="module-utils_chartDomUtils.html">utils/chartDomUtils</a></li><li><a href="module-utils_chartMetadataStore.html">utils/chartMetadataStore</a></li><li><a href="module-utils_computedChannelMetadata.html">utils/computedChannelMetadata</a></li><li><a href="module-utils_constants.html">utils/constants</a></li><li><a href="module-utils_helpers.html">utils/helpers</a></li><li><a href="module-utils_sidebarStore.html">utils/sidebarStore</a></li><li><a href="module-workers_computedChannelWorker.html">workers/computedChannelWorker</a></li></ul><h3>Classes</h3><ul><li><a href="module-components_PolarChartCanvas.PolarChartCanvas.html">PolarChartCanvas</a></li><li><a href="module-utils_computedChannelMetadata-ComputedChannelMetadata.html">ComputedChannelMetadata</a></li></ul><h3>Global</h3><ul><li><a href="global.html#IMPLEMENTATION_COMPLETE">IMPLEMENTATION_COMPLETE</a></li><li><a href="global.html#QUICK_REFERENCE">QUICK_REFERENCE</a></li><li><a href="global.html#STORAGE_CFG_KEY">STORAGE_CFG_KEY</a></li><li><a href="global.html#ZOOM_ICONS">ZOOM_ICONS</a></li><li><a href="global.html#adjustMainContent">adjustMainContent</a></li><li><a href="global.html#appendComputedChannelToStorage">appendComputedChannelToStorage</a></li><li><a href="global.html#applyZoom">applyZoom</a></li><li><a href="global.html#attachChartContainer">attachChartContainer</a></li><li><a href="global.html#attachChartEventHandlers">attachChartEventHandlers</a></li><li><a href="global.html#attachChartPlugins">attachChartPlugins</a></li><li><a href="global.html#attachComputedChartContainer">attachComputedChartContainer</a></li><li><a href="global.html#attachComputedChartEventHandlers">attachComputedChartEventHandlers</a></li><li><a href="global.html#attachComputedChartPlugins">attachComputedChartPlugins</a></li><li><a href="global.html#broadcastComputedChannelChange">broadcastComputedChannelChange</a></li><li><a href="global.html#buildChartData">buildChartData</a></li><li><a href="global.html#buildChartOptions">buildChartOptions</a></li><li><a href="global.html#buildComputedChannelLabels">buildComputedChannelLabels</a></li><li><a href="global.html#buildComputedChartOptions">buildComputedChartOptions</a></li><li><a href="global.html#buildGroupsWithAutoGrouping">buildGroupsWithAutoGrouping</a></li><li><a href="global.html#buildGroupsWithUserAssignments">buildGroupsWithUserAssignments</a></li><li><a href="global.html#buildUnitChartData">buildUnitChartData</a></li><li><a href="global.html#calculateStats">calculateStats</a></li><li><a href="global.html#chart2">chart2</a></li><li><a href="global.html#cleanupOldComputedCharts">cleanupOldComputedCharts</a></li><li><a href="global.html#clearChartsContainer">clearChartsContainer</a></li><li><a href="global.html#clearComputedChannelsFromStorage">clearComputedChannelsFromStorage</a></li><li><a href="global.html#clearExpressionCache">clearExpressionCache</a></li><li><a href="global.html#closeAnalysisDrawer">closeAnalysisDrawer</a></li><li><a href="global.html#collectChartDeltas">collectChartDeltas</a></li><li><a href="global.html#computeChartDataDimensions">computeChartDataDimensions</a></li><li><a href="global.html#createBinaryBlob">createBinaryBlob</a></li><li><a href="global.html#createChannelList">createChannelList</a></li><li><a href="global.html#createChartMetadata">createChartMetadata</a></li><li><a href="global.html#createChartOptions">createChartOptions</a></li><li><a href="global.html#createComputedChartMetadata">createComputedChartMetadata</a></li><li><a href="global.html#createComputedClickHandler">createComputedClickHandler</a></li><li><a href="global.html#createComputedMousemoveHandler">createComputedMousemoveHandler</a></li><li><a href="global.html#createDigitalFillPlugin">createDigitalFillPlugin</a></li><li><a href="global.html#createGroupDragBar">createGroupDragBar</a></li><li><a href="global.html#createMousemoveHandler">createMousemoveHandler</a></li><li><a href="global.html#createScopeTemplate">createScopeTemplate</a></li><li><a href="global.html#createState">createState</a></li><li><a href="global.html#createVerticalLineClickHandler">createVerticalLineClickHandler</a></li><li><a href="global.html#createZoomControlsHTML">createZoomControlsHTML</a></li><li><a href="global.html#debounce">debounce</a></li><li><a href="global.html#deleteComputedChannelFromStorage">deleteComputedChannelFromStorage</a></li><li><a href="global.html#encodeFloat64">encodeFloat64</a></li><li><a href="global.html#encodeInt32">encodeInt32</a></li><li><a href="global.html#evaluateExpression">evaluateExpression</a></li><li><a href="global.html#exportAllChannelsAsCSV">exportAllChannelsAsCSV</a></li><li><a href="global.html#exportComputedChannelsAsCSV">exportComputedChannelsAsCSV</a></li><li><a href="global.html#extractChannelMetadata">extractChannelMetadata</a></li><li><a href="global.html#extractChannelNameFromEquation">extractChannelNameFromEquation</a></li><li><a href="global.html#extractGroupId">extractGroupId</a></li><li><a href="global.html#extractMathExpression">extractMathExpression</a></li><li><a href="global.html#filterGroupsWithChannels">filterGroupsWithChannels</a></li><li><a href="global.html#filterUnassignedComputedChannels">filterUnassignedComputedChannels</a></li><li><a href="global.html#filterValidIndices">filterValidIndices</a></li><li><a href="global.html#formatEquationForLatex">formatEquationForLatex</a></li><li><a href="global.html#formatScaledValue">formatScaledValue</a></li><li><a href="global.html#generateCFGContentBinary32">generateCFGContentBinary32</a></li><li><a href="global.html#generateCFGContentBinary64">generateCFGContentBinary64</a></li><li><a href="global.html#generateCFGContentFloat32">generateCFGContentFloat32</a></li><li><a href="global.html#generateCFGContentFloat64">generateCFGContentFloat64</a></li><li><a href="global.html#generateDATContentBinary32">generateDATContentBinary32</a></li><li><a href="global.html#generateDATContentBinary64">generateDATContentBinary64</a></li><li><a href="global.html#generateDATContentFloat32">generateDATContentFloat32</a></li><li><a href="global.html#generateDATContentFloat64">generateDATContentFloat64</a></li><li><a href="global.html#getCacheStats">getCacheStats</a></li><li><a href="global.html#getChannelByDisplayName">getChannelByDisplayName</a></li><li><a href="global.html#getChannelMetadata">getChannelMetadata</a></li><li><a href="global.html#getChannelsForFile">getChannelsForFile</a></li><li><a href="global.html#getCompiledExpression">getCompiledExpression</a></li><li><a href="global.html#getComputedChannelById">getComputedChannelById</a></li><li><a href="global.html#getComputedChannelStorageMetadata">getComputedChannelStorageMetadata</a></li><li><a href="global.html#getComputedChannelsState">getComputedChannelsState</a></li><li><a href="global.html#getElementWidth">getElementWidth</a></li><li><a href="global.html#getFileIndexForTime">getFileIndexForTime</a></li><li><a href="global.html#getOriginalChannelName">getOriginalChannelName</a></li><li><a href="global.html#getSampleIndexInFile">getSampleIndexInFile</a></li><li><a href="global.html#getZoomLevel">getZoomLevel</a></li><li><a href="global.html#groupChannelsByUnit">groupChannelsByUnit</a></li><li><a href="global.html#handleComputedVerticalLineAddition">handleComputedVerticalLineAddition</a></li><li><a href="global.html#handleVerticalLineAddition">handleVerticalLineAddition</a></li><li><a href="global.html#hasStoredComputedChannels">hasStoredComputedChannels</a></li><li><a href="global.html#initComputedChannelsState">initComputedChannelsState</a></li><li><a href="global.html#initializeChartInstance">initializeChartInstance</a></li><li><a href="global.html#initializeComputedChartInstance">initializeComputedChartInstance</a></li><li><a href="global.html#initializeSidebarChannels">initializeSidebarChannels</a></li><li><a href="global.html#initializeZoomControls">initializeZoomControls</a></li><li><a href="global.html#injectZoomControls">injectZoomControls</a></li><li><a href="global.html#isMathJaxLoaded">isMathJaxLoaded</a></li><li><a href="global.html#listenForComputedChannelChanges">listenForComputedChannelChanges</a></li><li><a href="global.html#loadComputedChannelsForGroup">loadComputedChannelsForGroup</a></li><li><a href="global.html#loadComputedChannelsFromStorage">loadComputedChannelsFromStorage</a></li><li><a href="global.html#loadMathJax">loadMathJax</a></li><li><a href="global.html#mathJaxPromise">mathJaxPromise</a></li><li><a href="global.html#measurePerformance">measurePerformance</a></li><li><a href="global.html#mergeAnalogAndComputedMetadata">mergeAnalogAndComputedMetadata</a></li><li><a href="global.html#mergeAnalogChannels">mergeAnalogChannels</a></li><li><a href="global.html#mergeComtradeFilesSetsSequential">mergeComtradeFilesSetsSequential</a></li><li><a href="global.html#mergeDigitalChannels">mergeDigitalChannels</a></li><li><a href="global.html#mergeTimeArraysSequential">mergeTimeArraysSequential</a></li><li><a href="global.html#openAnalysisDrawer">openAnalysisDrawer</a></li><li><a href="global.html#openBothSidebars">openBothSidebars</a></li><li><a href="global.html#openDeltaWindow">openDeltaWindow</a></li><li><a href="global.html#openPhasorDiagram">openPhasorDiagram</a></li><li><a href="global.html#prepareChartDataContext">prepareChartDataContext</a></li><li><a href="global.html#processEquationInput">processEquationInput</a></li><li><a href="global.html#renameChannelWithPrefix">renameChannelWithPrefix</a></li><li><a href="global.html#renderChannelLabelContainer">renderChannelLabelContainer</a></li><li><a href="global.html#renderComputedChannels">renderComputedChannels</a></li><li><a href="global.html#renderLatex">renderLatex</a></li><li><a href="global.html#resetZoom">resetZoom</a></li><li><a href="global.html#resizeChartsToContainers">resizeChartsToContainers</a></li><li><a href="global.html#resolveGroupIndices">resolveGroupIndices</a></li><li><a href="global.html#resolveTimeArray">resolveTimeArray</a></li><li><a href="global.html#saveComputedChannelsToStorage">saveComputedChannelsToStorage</a></li><li><a href="global.html#setZoomLevel">setZoomLevel</a></li><li><a href="global.html#setupMobileSidebar">setupMobileSidebar</a></li><li><a href="global.html#showChannelListWindow">showChannelListWindow</a></li><li><a href="global.html#showFileInfo">showFileInfo</a></li><li><a href="global.html#subscribeChartUpdates">subscribeChartUpdates</a></li><li><a href="global.html#syncComputedChannelsWithParent">syncComputedChannelsWithParent</a></li><li><a href="global.html#toggleChartsVisibility">toggleChartsVisibility</a></li><li><a href="global.html#updateComputedChannelGroupInStorage">updateComputedChannelGroupInStorage</a></li><li><a href="global.html#updateComputedChannelInStorage">updateComputedChannelInStorage</a></li><li><a href="global.html#updateFileInfo">updateFileInfo</a></li><li><a href="global.html#updateMainZoomPosition">updateMainZoomPosition</a></li><li><a href="global.html#updateStatsCards">updateStatsCards</a></li><li><a href="global.html#updateZoomDisplay">updateZoomDisplay</a></li><li><a href="global.html#validateChannelName">validateChannelName</a></li><li><a href="global.html#validateGroupIndices">validateGroupIndices</a></li><li><a href="global.html#wrapChartInSection">wrapChartInSection</a></li><li><a href="global.html#zoomIn">zoomIn</a></li><li><a href="global.html#zoomOut">zoomOut</a></li></ul></div>
                
            </nav>
        </div>
        <div class="core" id="main-content-wrapper">
            <div class="content">
                <header class="page-title">
                    <p>Source</p>
                    <h1>services/computedChannels/resultProcessing.js</h1>
                </header>
                



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file resultProcessing.js
 * @module services/computedChannels/resultProcessing
 * 
 * @description
 * &lt;h3>Worker Results Processing&lt;/h3>
 * 
 * &lt;p>Processes results from the computation Web Worker.
 * Handles ArrayBuffer conversion, statistics, and metadata building.&lt;/p>
 * 
 * &lt;h4>Data Flow&lt;/h4>
 * &lt;ol>
 *   &lt;li>Worker resultsBuffer (ArrayBuffer)&lt;/li>
 *   &lt;li>‚Üì &lt;code>convertResultsToArray()&lt;/code>&lt;/li>
 *   &lt;li>JavaScript Array&lt;/li>
 *   &lt;li>‚Üì &lt;code>calculateStatistics()&lt;/code>&lt;/li>
 *   &lt;li>Stats: { min, max, mean, count }&lt;/li>
 *   &lt;li>‚Üì &lt;code>buildChannelData()&lt;/code>&lt;/li>
 *   &lt;li>Output: { metadata, values }&lt;/li>
 * &lt;/ol>
 * 
 * &lt;h4>Output Format&lt;/h4>
 * &lt;p>Matches the analog/digital data pattern:&lt;/p>
 * &lt;table>
 *   &lt;tr>&lt;th>Output&lt;/th>&lt;th>Destination&lt;/th>&lt;th>Analog Equivalent&lt;/th>&lt;/tr>
 *   &lt;tr>&lt;td>metadata&lt;/td>&lt;td>&lt;code>cfg.computedChannels[i]&lt;/code>&lt;/td>&lt;td>&lt;code>cfg.analogChannels&lt;/code>&lt;/td>&lt;/tr>
 *   &lt;tr>&lt;td>values&lt;/td>&lt;td>&lt;code>data.computedData[i]&lt;/code>&lt;/td>&lt;td>&lt;code>data.analogData&lt;/code>&lt;/td>&lt;/tr>
 * &lt;/table>
 * 
 * @see {@link module:services/computedChannels} - Main orchestrator
 * @see {@link module:services/computedChannels/stateUpdate} - Consumes output
 * 
 * @example
 * const results = convertResultsToArray(resultsBuffer);
 * const stats = calculateStatistics(results);
 * const channelData = buildChannelData(results, expr, mathExpr, unit, stats, "MyChannel");
 */

/**
 * Convert ArrayBuffer to JavaScript array.
 * Worker returns Float64Array.buffer, this converts back to Array.
 * 
 * @function convertResultsToArray
 * @memberof module:services/computedChannels/resultProcessing
 * @param {ArrayBuffer} resultsBuffer - ArrayBuffer from worker
 * @returns {number[]} JavaScript array of computed values
 * 
 * @example
 * const results = convertResultsToArray(e.data.resultsBuffer);
 * console.log(results.slice(0, 5)); // [1.23, 4.56, ...]
 */
export const convertResultsToArray = (resultsBuffer) => {
  return Array.from(new Float64Array(resultsBuffer));
};

/**
 * Extract channel names used in the math expression.
 * Parses the expression to find all variable names that could be channels.
 * 
 * @function extractUsedChannels
 * @private
 * @param {string} mathJsExpr - The mathematical expression (e.g., "sqrt(IA^2 + IB^2)")
 * @returns {Set&lt;string>} Set of channel identifiers used in the expression
 * 
 * @example
 * extractUsedChannels("sqrt(IA^2 + IB^2 + IC^2)");
 * // Set { "IA", "IB", "IC" }
 */
const extractUsedChannels = (mathJsExpr) => {
  if (!mathJsExpr || typeof mathJsExpr !== "string") {
    return new Set();
  }
  
  const usedChannels = new Set();
  // Match valid variable names: letters, numbers, underscores
  const tokens = mathJsExpr.match(/\b[a-zA-Z_][a-zA-Z0-9_]*\b/g) || [];
  
  // Math.js functions and constants to filter out
  const mathJsFunctions = new Set([
    "sin", "cos", "tan", "asin", "acos", "atan", "atan2",
    "sinh", "cosh", "tanh", "asinh", "acosh", "atanh",
    "sqrt", "pow", "abs", "log", "log10", "log2", "exp",
    "min", "max", "sum", "mean", "median", "std", "variance",
    "random", "floor", "ceil", "round", "fix", "sign",
    "pi", "e", "i", "true", "false", "null", "undefined",
    "mod", "gcd", "lcm", "factorial",
  ]);
  
  tokens.forEach((token) => {
    if (!mathJsFunctions.has(token.toLowerCase())) {
      usedChannels.add(token);
    }
  });
  
  return usedChannels;
};

/**
 * Check if computed values are binary (only 0 and 1).
 * Used to determine if a computed channel from digital sources should be
 * rendered as digital (binary output) or analog (non-binary like sum of digitals).
 * 
 * @function areBinaryValues
 * @memberof module:services/computedChannels/resultProcessing
 * @param {number[]} values - The computed values array
 * @returns {boolean} True if all values are 0 or 1
 * 
 * @example
 * areBinaryValues([0, 1, 1, 0, 1]);  // true - valid binary
 * areBinaryValues([0, 1, 2, 3]);     // false - contains non-binary
 * areBinaryValues([3, 3, 3]);        // false - sum of digitals
 */
export const areBinaryValues = (values) => {
  if (!Array.isArray(values) || values.length === 0) return false;
  
  // Check first 1000 samples for performance (or all if less)
  const samplesToCheck = Math.min(values.length, 1000);
  
  for (let i = 0; i &lt; samplesToCheck; i++) {
    const val = values[i];
    // ‚úÖ FIX: Simple check - value must be exactly 0 or 1
    // Non-binary values like 2, 3, -1, 1.5 etc. should return false
    if (val !== 0 &amp;&amp; val !== 1) {
      console.log(`[areBinaryValues] ‚ùå Non-binary value at index ${i}: ${val}`);
      return false;
    }
  }
  
  console.log(`[areBinaryValues] ‚úÖ All ${samplesToCheck} checked values are binary (0 or 1)`);
  return true;
};

/**
 * Detect whether a computed channel should be rendered as analog or digital
 * based on the source channels referenced in its formula.
 * 
 * **Detection Logic:**
 * 1. Parse the formula to extract all channel references
 * 2. Match each reference against cfg.analogChannels and cfg.digitalChannels
 * 3. Count how many analog vs digital channels are referenced
 * 4. Return the dominant type (analog wins ties, or if no matches found)
 * 
 * **Matching Strategy:**
 * - Matches by channel ID (e.g., "IA", "VA_PH")
 * - Matches by indexed format (e.g., "a0" ‚Üí analog index 0, "d5" ‚Üí digital index 5)
 * - Matches by channel name
 * 
 * @function detectMadeFrom
 * @memberof module:services/computedChannels/resultProcessing
 * @param {string} mathJsExpr - The math.js compatible expression
 * @returns {string} "analog" or "digital"
 * 
 * @example
 * // Formula using analog channels IA, IB, IC
 * detectMadeFrom("sqrt(IA^2 + IB^2 + IC^2)");  // "analog"
 * 
 * // Formula using digital channel indexed as d0
 * detectMadeFrom("d0 + d1");  // "digital"
 * 
 * // Formula using mixed channels - analog wins
 * detectMadeFrom("IA * d0");  // "analog" (tie goes to analog)
 */
export const detectMadeFrom = (mathJsExpr) => {
  console.log("[detectMadeFrom] üîç Analyzing expression:", mathJsExpr);
  
  const usedChannels = extractUsedChannels(mathJsExpr);
  
  if (usedChannels.size === 0) {
    console.log("[detectMadeFrom] ‚ö†Ô∏è No channel references found, defaulting to analog");
    return "analog";
  }
  
  console.log("[detectMadeFrom] üìã Found channel references:", [...usedChannels]);
  
  // Get channel arrays from global config
  const analogChannels = window.globalCfg?.analogChannels || [];
  const digitalChannels = window.globalCfg?.digitalChannels || [];
  
  // Build lookup sets for faster matching
  const analogIds = new Set();
  const digitalIds = new Set();
  
  // Add analog channel identifiers (multiple formats)
  analogChannels.forEach((ch, idx) => {
    if (ch.channelID) analogIds.add(ch.channelID);
    if (ch.id) analogIds.add(ch.id);
    if (ch.name) analogIds.add(ch.name);
    // Add indexed format: a0, a1, a2, ...
    analogIds.add(`a${idx}`);
  });
  
  // Add digital channel identifiers (multiple formats)
  digitalChannels.forEach((ch, idx) => {
    if (ch.channelID) digitalIds.add(ch.channelID);
    if (ch.id) digitalIds.add(ch.id);
    if (ch.name) digitalIds.add(ch.name);
    // Add indexed format: d0, d1, d2, ...
    digitalIds.add(`d${idx}`);
  });
  
  console.log("[detectMadeFrom] üìä Available channels:", {
    analogCount: analogIds.size,
    digitalCount: digitalIds.size,
  });
  
  // Count matches
  let analogMatches = 0;
  let digitalMatches = 0;
  
  for (const ref of usedChannels) {
    if (analogIds.has(ref)) {
      analogMatches++;
      console.log(`[detectMadeFrom]   ‚úì "${ref}" ‚Üí analog`);
    } else if (digitalIds.has(ref)) {
      digitalMatches++;
      console.log(`[detectMadeFrom]   ‚úì "${ref}" ‚Üí digital`);
    } else {
      console.log(`[detectMadeFrom]   ? "${ref}" ‚Üí not found in cfg`);
    }
  }
  
  console.log("[detectMadeFrom] üìà Match counts:", { analogMatches, digitalMatches });
  
  // Determine type: digital only if ALL matches are digital (and at least 1 match)
  // Otherwise default to analog
  if (digitalMatches > 0 &amp;&amp; analogMatches === 0) {
    console.log("[detectMadeFrom] ‚úÖ Result: digital (all references are digital)");
    return "digital";
  }
  
  console.log("[detectMadeFrom] ‚úÖ Result: analog (default or has analog references)");
  return "analog";
};

/**
 * Calculate statistics from computed results.
 * Filters out non-finite and zero values before calculation.
 * 
 * @function calculateStatistics
 * @memberof module:services/computedChannels/resultProcessing
 * @param {number[]} results - Array of computed values
 * @returns {Object} Statistics object
 * @returns {number} returns.min - Minimum valid value
 * @returns {number} returns.max - Maximum valid value
 * @returns {number} returns.mean - Mean of valid values
 * @returns {number} returns.count - Total sample count
 * @returns {number} returns.validCount - Count of valid (finite, non-zero) values
 * 
 * @example
 * const stats = calculateStatistics([1, 2, 3, 0, Infinity, NaN, 4]);
 * // { min: 1, max: 4, mean: 2.5, count: 7, validCount: 4 }
 */
export const calculateStatistics = (results) => {
  const validResults = results.filter((v) => isFinite(v) &amp;&amp; v !== 0);

  if (validResults.length === 0) {
    return {
      min: 0,
      max: 0,
      mean: 0,
      count: results.length,
      validCount: 0,
    };
  }

  return {
    min: Math.min(...validResults),
    max: Math.max(...validResults),
    mean: validResults.reduce((a, b) => a + b, 0) / validResults.length,
    count: results.length,
    validCount: validResults.length,
  };
};

/**
 * Generate unique channel name.
 * Uses custom name if provided, otherwise generates timestamp-based name.
 * 
 * @function generateChannelName
 * @memberof module:services/computedChannels/resultProcessing
 * @param {string|null} [customChannelName=null] - User-provided name (from "name = expr" format)
 * @returns {string} Channel name to use
 * 
 * @example
 * generateChannelName("I_RMS");  // "I_RMS"
 * generateChannelName(null);      // "computed_1705678901234"
 * generateChannelName("");        // "computed_1705678901234"
 */
export const generateChannelName = (customChannelName = null) => {
  if (
    customChannelName &amp;&amp;
    typeof customChannelName === "string" &amp;&amp;
    customChannelName.trim()
  ) {
    const finalName = customChannelName.trim();
    console.log("[resultProcessing] ‚úÖ Using custom channel name:", finalName);
    return finalName;
  }

  const timestampName = `computed_${Date.now()}`;
  console.log(
    "[resultProcessing] ‚è±Ô∏è No custom name, using timestamp:",
    timestampName
  );
  return timestampName;
};

function detectComputedGroup() {
  const parseIndex = (value) => {
    if (typeof value !== "string") return null;
    if (!value.startsWith("G")) return null;
    const parsed = parseInt(value.slice(1), 10);
    return Number.isNaN(parsed) ? null : parsed;
  };

  let maxIndex = -1;

  try {
    const globalRef =
      typeof window !== "undefined"
        ? window
        : typeof globalThis !== "undefined"
        ? globalThis
        : null;
    const metadataState = globalRef?.__chartMetadataState;
    if (metadataState) {
      const { charts, nextUserGroupId } = metadataState;
      if (Array.isArray(charts)) {
        charts.forEach((chart) => {
          const idx = parseIndex(chart?.userGroupId);
          if (idx !== null &amp;&amp; idx > maxIndex) {
            maxIndex = idx;
          }
        });
      }
      if (typeof nextUserGroupId === "number") {
        maxIndex = Math.max(maxIndex, nextUserGroupId - 1);
      }
    }

    const cfgGroups = globalRef?.globalCfg?.computedChannels;
    if (Array.isArray(cfgGroups)) {
      cfgGroups.forEach((item) => {
        const idx = parseIndex(item?.group);
        if (idx !== null &amp;&amp; idx > maxIndex) {
          maxIndex = idx;
        }
      });
    }

    const collectFromState = (list) => {
      if (!Array.isArray(list)) return;
      list.forEach((value) => {
        const idx = parseIndex(value);
        if (idx !== null &amp;&amp; idx > maxIndex) {
          maxIndex = idx;
        }
      });
    };

    collectFromState(globalRef?.channelState?.analog?.groups);
    collectFromState(globalRef?.channelState?.digital?.groups);
    collectFromState(globalRef?.channelState?.computed?.groups);
  } catch (error) {
    console.warn(
      "[resultProcessing] Group detection failed, defaulting to G0",
      error
    );
  }

  const nextIndex = maxIndex + 1;
  return `G${Math.max(0, nextIndex)}`;
}

/**
 * Build channel data object from results
 * ‚úÖ REFACTORED: Returns SEPARATE metadata and values (like analog/digital)
 * 
 * Structure matches analog/digital pattern:
 * - metadata ‚Üí goes to cfg.computedChannels[] (like cfg.analogChannels)
 * - values   ‚Üí goes to data.computedData[][] (like data.analogData)
 * 
 * @param {Array} results - Computed values array
 * @param {string} expression - Original LaTeX expression
 * @param {string} mathJsExpr - Converted math.js expression
 * @param {string} unit - Unit string
 * @param {Object} stats - Statistics object
 * @param {string} customChannelName - Custom name or null
 * @param {string} groupOverride - Group override or null
 * @returns {Object} { metadata: {...}, values: [...] }
 */
export const buildChannelData = (
  results,
  expression,
  mathJsExpr,
  unit,
  stats,
  customChannelName = null,
  groupOverride = null
) => {
  console.log("[resultProcessing] üèóÔ∏è buildChannelData called with:", {
    customChannelName: customChannelName,
    expression: expression,
    mathJsExpr: mathJsExpr,
    hasResults: !!results,
    resultCount: results?.length,
  });

  const channelName = generateChannelName(customChannelName);

  console.log("[resultProcessing] üìù Final channel name:", channelName);

  const resolvedGroup =
    typeof groupOverride === "string" &amp;&amp; groupOverride.trim()
      ? groupOverride
      : detectComputedGroup();

  // ‚úÖ ASSIGN COLOR FROM PALETTE (index-based at creation time)
  // Count existing channels from BOTH cfg.computedChannels (metadata) 
  const cfgComputedCount = window.globalCfg?.computedChannels?.length || 0;
  const dataComputedCount = Array.isArray(window.globalData?.computedData) 
    ? window.globalData.computedData.length 
    : 0;
  const computedIndex = Math.max(cfgComputedCount, dataComputedCount);
  
  const computedPalette = (typeof window !== "undefined" &amp;&amp;
    window.COMPUTED_CHANNEL_COLORS) || [
    "#dc2626", // red-600
    "#2563eb", // blue-600
    "#16a34a", // green-600
    "#9333ea", // purple-700
    "#ea580c", // orange-600
    "#0d9488", // teal-600
    "#b45309", // amber-700
    "#be185d", // pink-600
  ];
  const assignedColor = computedPalette[computedIndex % computedPalette.length];

  console.log("[resultProcessing] üé® Assigned color:", {
    index: computedIndex,
    color: assignedColor,
    paletteSize: computedPalette.length,
  });

  // ‚úÖ DETECT SOURCE TYPE (analog or digital) based on formula references
  let madeFromType = detectMadeFrom(mathJsExpr);
  let finalResults = results;  // May be converted to binary

  console.log("[resultProcessing] üè∑Ô∏è Detected madeFrom from formula:", madeFromType);

  // ‚úÖ SMART CONVERSION: If madeFrom is "digital" but values are NOT binary (0/1),
  // convert values to binary using OR logic (any non-zero ‚Üí 1)
  // This allows digital formulas like A+B+C to produce valid digital output
  if (madeFromType === "digital" &amp;&amp; !areBinaryValues(results)) {
    console.log("[resultProcessing] üîÑ Digital formula produced non-binary values!");
    console.log("[resultProcessing]   Sample BEFORE conversion:", results.slice(0, 10));
    
    // Convert to binary: value > 0 ‚Üí 1, value == 0 ‚Üí 0 (OR logic)
    finalResults = results.map(v => (v > 0 ? 1 : 0));
    
    console.log("[resultProcessing]   Sample AFTER conversion:", finalResults.slice(0, 10));
    console.log("[resultProcessing] ‚úÖ Converted to binary OR output - keeping madeFrom='digital'");
  }

  console.log("[resultProcessing] üè∑Ô∏è Final madeFrom:", madeFromType);

  // ‚úÖ METADATA ONLY (like cfg.analogChannels) - NO data array!
  const metadata = {
    index: computedIndex,
    id: channelName,
    channelID: channelName,
    name: channelName,
    equation: expression,
    mathJsExpression: mathJsExpr,
    unit: unit || "",
    group: resolvedGroup,
    color: assignedColor,
    type: "Computed",
    madeFrom: madeFromType,  // ‚úÖ Now auto-detected from formula!
    stats: stats,
    sampleCount: finalResults.length,  // ‚úÖ Use finalResults
    createdAt: Date.now(),
    // ‚ùå NO data/results array here - matches analog pattern!
  };

  // ‚úÖ VALUES ONLY (like data.analogData[]) - Just the number array
  const values = finalResults;  // ‚úÖ Use finalResults (may be converted to binary)

  console.log("[resultProcessing] ‚úÖ Built SEPARATED structure:", {
    metadataKeys: Object.keys(metadata),
    valuesLength: values.length,
    hasDataInMetadata: "data" in metadata, // Should be false
    madeFrom: madeFromType,
    sampleValues: values.slice(0, 5),
  });

  return {
    metadata,
    values,
    // ‚úÖ LEGACY: Keep combined object for backward compatibility during transition
    combined: {
      ...metadata,
      data: finalResults,     // ‚úÖ Use finalResults
      results: finalResults,  // ‚úÖ Use finalResults
    }
  };
};
</code></pre>
        </article>
    </section>




            </div>
            
            <footer class="footer">
                <div class="content has-text-centered">
                    <p>Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.5</a></p>
                    <p class="sidebar-created-by">
                        <a href="https://github.com/SoftwareBrothers/better-docs" target="_blank">BetterDocs theme</a> provided with <i class="fas fa-heart"></i> by
                        <a href="http://softwarebrothers.co" target="_blank">SoftwareBrothers - JavaScript Development Agency</a>
                    </p>
                </div>
            </footer>
            
        </div>
        <div id="side-nav" class="side-nav">
        </div>
    </div>
<script src="scripts/app.min.js"></script>
<script>PR.prettyPrint();</script>
<script src="scripts/linenumber.js"> </script>


</body>
</html>
